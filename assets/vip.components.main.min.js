var COMP_COLOR_ACTIVE,COMP_COLOR_PLACED,COMP_FURNITURE_COLOR_ACTIVE,COMP_FURNITURE_COLOR_PLACED,$compDragNode,$compSelected,dropSelectedDropID,compSelectedType,compSelectedRotation,compSelectedScaleX,compSelectedScaleY,compSelectedDimensionWidth,compSelectedDimensionHeight,compSelectedDimensionFixed,compSelectedDimensionNoSize,compSelectedFlippedH,compSelectedFlippedV,compSelectedForceTop,compSelectedForceBottom,compSelectedTmpMX,compHaloRotatorPageX,compHaloRotatorPageY,compHaloRotatorPageCenterX,compHaloRotatorPageCenterY,compHaloRotatorCenterOffsetX,compHaloRotatorCenterOffsetY,compHaloRotatorDefaultRadians,compHaloRotatorDefaultMX,uiToolCurrent,COMP_COLOR_UNDEFINED="#000001",COMP_ICON_WIDTH=600,COMP_ICON_HEIGHT=600,COMP_LIBRARY_DIMENSION_SCALE=2,COMP_PULSE_SIZE_DESKTOP=50,COMP_PULSE_SIZE_TOUCH=50,COMP_PULSE_TIME_DOWN=200,COMP_HALO_WIDTH=10,COMP_HALO_HEIGHT=10,COMP_HALO_MIN_WIDTH=200,COMP_HALO_MIN_HEIGHT=125,COMP_HALO_MARGIN_BTNS=40,COMP_HALO_ROTATOR_ANGLE=225,COMP_HALO_ROTATOR_STEP_ANGLE=5,COMP_HALO_COLOR_BASE="#000000",COMP_HALO_COLOR="#000099",COMP_HALO_COLOR_HOVER="#0000ff",DROP_NOTEBAR_HEIGHT=35,DROP_NOTEBAR_DRAG_OFFSET_X=17,DROP_NOTEBAR_DRAG_OFFSET_Y=14,compDropAdjustX=-1,compDropAdjustY=-1,compSelectedRotationOriginal=0,dropSelectedPositionPage={x1:0,y1:0,x2:void 0,y2:void 0},dropSelectedPositionPlan={x1:0,y1:0,x2:void 0,y2:void 0},dropSelectedData={},compPulseDownComplete=!1,compPulseDownWidth=0,compPulseDownHeight=0,compHaloCurrentWidth=0,compHaloCurrentHeight=0,compHaloCurrentDragOffsetX=0,compHaloCurrentDragOffsetY=0;function uiComponentsSetup(type,$container){var $compList,$compSVGData,$compItem,$compItemG,$compGroupXMLNode,compID,compSVGID,$compSVG,compDimenMax,compScale;$container.empty(),$($dataComponents.find('group[type="'+type+'"]')).each((function(index,element){$compGroupXMLNode=$(this),$compGroupXMLNode.attr("id"),$compList=$('<div data-role="collapsible" data-inset="false" data-mini="true" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d" data-iconpos="right"><h3>'+$compGroupXMLNode.attr("displayname")+'</h3><ul id="ulOpts_Components" data-role="listview" data-theme="k" data-dividertheme="k"></ul></div>');var urlSVG=$(this).attr("svgfile");$.ajax({url:urlSVG,dataType:"xml",async:!1,success:function(data,textStatus,jqXHR){$compSVGData=$($(data).find("svg")[0]),$compGroupXMLNode.find("component").each((function(){compID=$(this).attr("id"),$compItem=$('<li data-mini="true" data-icon="false" class="ui-li-component"><a draggable="true"><svg id="'+("svgComponent_"+type+"_"+compID)+'" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" viewbox="0 0 '+COMP_ICON_WIDTH+" "+COMP_ICON_HEIGHT+'" class="svg-component"></svg>'+$(this).attr("displayname")+"</a></li>"),compSVGID=$(this).attr("svgid"),($compItemG=$compSVGData.find("#"+strEscapeDots(compSVGID))).removeAttr("id"),$compSVG=$compItem.find("svg");var compDimensInfo=componentGetDimensions(compID);compDimenMax=compDimensInfo.width>compDimensInfo.height?compDimensInfo.width:compDimensInfo.height,compScale=COMP_ICON_WIDTH/(compDimenMax*=COMP_LIBRARY_DIMENSION_SCALE),mx=xfrmCSSGet($compSVG),mx=xfrmMatrixScale(mx,compScale,compScale),xfrmCSSSet($compSVG,mx,!0),$compSVG.append($compItemG);var $compItemLink=$compItem.find("a");$compItemLink.hammer(),$compItemLink.data("hammer").get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0}),$compItemLink.on("pan panstart",componentDragNH),$compItemLink.on("panend",componentDragStopNH),$compItemLink.on("mousedown",(function(e){e.preventDefault&&e.preventDefault()})),$compList.find("ul").append($compItem)})),$compList.find("ul").children().length>0&&($container.append($compList),$container.trigger("create"))}})})),0===$container.children().length&&$container.html("<p>There are no components available for this plan.</p>"),svgHighlight($("#svgHalo"),COMP_HALO_COLOR_BASE,COMP_HALO_COLOR);var $lblHaloSizeWidth=$("#lblHaloSizeWidth"),$lblHaloSizeHeight=$("#lblHaloSizeHeight");dataCompMetric?($lblHaloSizeWidth.text("Width (cm):"),$lblHaloSizeHeight.text("Height (cm):"),$("#gHaloSizeBkgrndImperial").remove()):($lblHaloSizeWidth.text("Width (in):"),$lblHaloSizeHeight.text("Height (in):"),$("#gHaloSizeBkgrndMetric").remove())}function uiComponentsSavedSetup(){var $dropNode,$dropViewsNode,dropType,dropCompDBID,dropData,dropPosition,$dropSVGElement;$dataViews.find("drop[type=component],drop[type=furniture]").each((function(){$dropNode=$(this),$dropViewsNode=$dropNode.parents("view"),dropType=$dropNode.attr("type"),dropCompDBID=$dropNode.attr("componentid"),$dropSVGElement=$("#"+("svgComponent_"+dropType+"_"+dropCompDBID)).clone(!1);var position=$dropNode.attr("position");position=position?JSON.parse(position):{x1:$dropNode.attr("x"),y1:$dropNode.attr("y")};var scaleCompInPlanDefault=svgDropGetPlanScale(dropType,void 0,void 0);$dropNode.attr("scalex")&&(scaleCompInPlanDefault.x=parseFloat($dropNode.attr("scalex"))),$dropNode.attr("scaley")&&(scaleCompInPlanDefault.y=parseFloat($dropNode.attr("scaley"))),svgDropCreateComponent($dropSVGElement,$dropViewsNode.attr("id"),dropCompDBID,$dropNode.attr("dropid"),position.x1,position.y1,$dropNode.attr("rotation"),scaleCompInPlanDefault.x,scaleCompInPlanDefault.y,!1,"true"===$dropNode.attr("forcetop"),"true"===$dropNode.attr("forcebottom"))})),$dataViews.find("drop[type=note]").each((function(){$dropNode=$(this),$dropViewsNode=$dropNode.parents("view"),dropData=$dropNode.attr("data"),dropPosition=$dropNode.attr("position"),dropData&&dropPosition&&(dropData=JSON.parse(dropData),dropPosition=JSON.parse(dropPosition),svgDropCreateNote(dropData.text,$dropViewsNode.attr("id"),$dropNode.attr("dropid"),dropPosition.x1,dropPosition.y1,$dropNode.attr("rotation"),!1))})),$dataViews.find("drop[type=line]").each((function(){$dropNode=$(this),$dropViewsNode=$dropNode.parents("view"),(dropPosition=$dropNode.attr("position"))&&(dropPosition=JSON.parse(dropPosition),svgDropCreateLine($dropViewsNode.attr("id"),$dropNode.attr("dropid"),dropPosition,0,!1))}))}function componentDragPulseDown(){compPulseDownComplete=!0,$compDragNode.animate({width:compPulseDownWidth,height:compPulseDownHeight},{duration:COMP_PULSE_TIME_DOWN,easing:"linear",step:componentDragPulseDownStep})}function componentDragPulseDownStep(now,fx){var $svgNode=$(this);if(fx.prop===$.cssProps.width){var widthWas=parseFloat($svgNode.css("width")),left=parseFloat($svgNode.css("left"));left+=(widthWas-now)/2,$svgNode.css("left",left+"px")}else{var heightWas=parseFloat($svgNode.css("height")),top=parseFloat($svgNode.css("top"));top+=(heightWas-now)/2,$svgNode.css("top",top+"px")}}function componentDragNH(e){dbg("componentDragNH e.type = "+e.type);var pageX,pageY,$target=$(e.target);if(pageX=e.gesture.center.x,pageY=e.gesture.center.y,"press"!==e.type&&"panstart"!==e.type){if(pageX&&pageY){var compWidth=$compDragNode.outerWidth(),compHeight=$compDragNode.outerHeight();$compDragNode.css("left",pageX-compWidth/2+"px"),$compDragNode.css("top",pageY-compHeight/2+"px");var $divStage=$("#divStage"),dropMinX=$divStage.offset().left,dropMaxX=$divStage.offset().left+$divStage.width(),dropMinY=$divStage.offset().top,dropMaxY=$divStage.offset().top+$divStage.height();pageX>dropMinX&&pageX<dropMaxX&&pageY>dropMinY&&pageY<dropMaxY&&(compPulseDownComplete||componentDragPulseDown())}return killEvent(e)}$compDragNode&&$compDragNode.remove();var $svgNodeOriginal=$target.find("svg:first");($compDragNode=$svgNodeOriginal.clone(!1)).css("transform","");var compType="component";-1!=$svgNodeOriginal.attr("id").indexOf("svgComponent_furniture_")&&(compType="furniture");var compSize=svgDropGetSizeForPage(compType);compPulseDownWidth=compSize.width,compPulseDownHeight=compSize.height;var compShouldPulse=!1,compOriginalBB=$svgNodeOriginal.get(0).getBBox(),compWidthOriginalBB=compOriginalBB.width,compHeightOriginalBB=compOriginalBB.height,compWidthPulseBB=compWidthOriginalBB,compHeightPulseBB=compHeightOriginalBB,compPulseSize=COMP_PULSE_SIZE_DESKTOP;isTouchDevice()&&(compPulseSize=COMP_PULSE_SIZE_TOUCH),compWidthOriginalBB<compPulseSize&&compWidthOriginalBB>compHeightOriginalBB?(compShouldPulse=!0,compHeightPulseBB=(compWidthPulseBB=compPulseSize)/compWidthOriginalBB*compHeightOriginalBB):compHeightOriginalBB<compPulseSize&&(compShouldPulse=!0,compWidthPulseBB=(compHeightPulseBB=compPulseSize)/compHeightOriginalBB*compWidthOriginalBB),compShouldPulse&&(compSize.width=compWidthPulseBB/compWidthOriginalBB*COMP_ICON_WIDTH,compSize.Height=compHeightPulseBB/compHeightOriginalBB*COMP_ICON_HEIGHT,compPulseDownComplete=!1,(compSize.width<compPulseDownWidth||compSize.Height<compPulseDownHeight)&&(compSize.width=compPulseDownWidth,compSize.Height=compPulseDownHeight,compPulseDownComplete=!0)),$compDragNode.attr("id","drag_"+$compDragNode.attr("id")),$compDragNode.css("width",compSize.width+"px"),$compDragNode.css("height",compSize.Height+"px"),$compDragNode.attr("class","ui-draggable"),$compDragNode.prependTo("body"),$compDragNode.css("left",pageX-compSize.width/2+"px"),$compDragNode.css("top",pageY-compSize.height/2+"px"),uiBlockMainUI(!0,!0),uiBlockStage(!0,!1)}function componentDragStopNH(e){var pageX,pageY;if(dbg("componentDragStopNH e.type = "+e.type),pageX=e.gesture.center.x,pageY=e.gesture.center.y,uiBlockMainUI(!1,void 0),uiBlockStage(!1,void 0),e.originalEvent&&(e=e.originalEvent),pageX&&pageY){var $divStage=$("#divStage"),$divPlan=$("#divPlan"),stageMinX=$divStage.offset().left+$("#pnlMainA").width(),planMinX=$divPlan.offset().left,dropMinX=stageMinX>planMinX?stageMinX:planMinX,stageMinY=$divStage.offset().top,planMinY=$divPlan.offset().top,dropMinY=stageMinY>planMinY?stageMinY:planMinY,stageMaxX=stageMinX+$divStage.width()-$("#pnlMainC").width(),planMaxX=planMinX+$divPlan.width(),dropMaxX=stageMaxX<planMaxX?stageMaxX:planMaxX,stageMaxY=stageMinY+$divStage.height(),planMaxY=planMinY+$divPlan.height();if(pageX>dropMinX&&pageX<dropMaxX&&pageY>dropMinY&&pageY<(stageMaxY<planMaxY?stageMaxY:planMaxY)){var compDBID=$compDragNode.attr("id");compDBID=(compDBID=compDBID.split("_"))[compDBID.length-1];var compDropID=dataDropCounter++,compType="component";-1!=$compDragNode.attr("id").indexOf("svgComponent_furniture_")&&(compType="furniture");var $compDropNode=$("<drop/>");$compDropNode.attr("componentid",compDBID),$compDropNode.attr("type",compType),$compDropNode.attr("dropid",compDropID);var scaleCompInPlan=svgDropGetPlanScale(compType,void 0,void 0);$compDropNode.attr("scalex",scaleCompInPlan.x),$compDropNode.attr("scaley",scaleCompInPlan.y),pageX=parseFloat(pageX)+compDropAdjustX,pageY=parseFloat(pageY)+compDropAdjustY;var compPlanPos=svgDropGetCoordsForPlan(pageX,pageY,compType,void 0,void 0);compPlanPos={x1:compPlanPos.x,y1:compPlanPos.y},$compDropNode.attr("position",JSON.stringify(compPlanPos)),$compDropNode.attr("rotation",0),$compDropNode.attr("flippedh","false"),$compDropNode.attr("flippedv","false");var compDimensInfo=componentGetDimensions(compDBID);$compDropNode.attr("dimensionwidth",compDimensInfo.width),$compDropNode.attr("dimensionheight",compDimensInfo.height),$compDropNode.attr("dimensionfixed",compDimensInfo.fixed),$compDropNode.attr("dimensionnosize",compDimensInfo.nosize),$compDropNode.attr("forcetop",compDimensInfo.forcetop),$compDropNode.attr("forcebottom",compDimensInfo.forcebottom);var $viewsDropsNode=$dataViews.find("view[id="+uiViewsCurrentID+"] drops");$compDropNode.appendTo($viewsDropsNode),svgDropCreateComponent($compDragNode,uiViewsCurrentID,compDBID,compDropID,compPlanPos.x,compPlanPos.y,0,scaleCompInPlan.x,scaleCompInPlan.y,!0,compDimensInfo.forcetop,compDimensInfo.forcebottom)}}return $compDragNode.remove(),killEvent(e)}function componentSelect($domElement,componentDropID){dbg("componentSelect $domElement.id,componentDropID = "+$($domElement).attr("id")+","+componentDropID),$compSelected=$($domElement),dropSelectedDropID=componentDropID;var $dropNode=$dataViews.find("drop[dropid="+dropSelectedDropID+"]");compSelectedType=$dropNode.attr("type"),compSelectedRotation=parseFloat($dropNode.attr("rotation"));var scaleCompInPlanDefault=svgDropGetPlanScale(compSelectedType,void 0,void 0);compSelectedScaleX=(compSelectedScaleX=parseFloat($dropNode.attr("scalex")))>0?compSelectedScaleX:scaleCompInPlanDefault.x,compSelectedScaleY=(compSelectedScaleY=parseFloat($dropNode.attr("scaley")))>0?compSelectedScaleY:scaleCompInPlanDefault.y,compSelectedFlippedH="true"===$dropNode.attr("flippedh"),compSelectedFlippedV="true"===$dropNode.attr("flippedv"),dropSelectedPositionPlan.x1=parseFloat($dropNode.attr("x")),dropSelectedPositionPlan.y1=parseFloat($dropNode.attr("y")),dropSelectedPositionPlan.x2=dropSelectedPositionPlan.y2=void 0;var compPagePos=svgDropGetCoordsForPage(dropSelectedPositionPlan.x1,dropSelectedPositionPlan.y1,compSelectedType,compSelectedScaleX,compSelectedScaleY);if(dropSelectedPositionPage.x1=compPagePos.x,dropSelectedPositionPage.y1=compPagePos.y,dropSelectedPositionPage.x2=dropSelectedPositionPage.y2=void 0,$dropNode.attr("position")){dropSelectedPositionPlan=JSON.parse($dropNode.attr("position"));var positionPage=svgDropGetCoordsForPage(dropSelectedPositionPlan.x1,dropSelectedPositionPlan.y1,compSelectedType,compSelectedScaleX,compSelectedScaleY);dropSelectedPositionPage.x1=positionPage.x,dropSelectedPositionPage.y1=positionPage.y,positionPage=svgDropGetCoordsForPage(dropSelectedPositionPlan.x2,dropSelectedPositionPlan.y2,compSelectedType,compSelectedScaleX,compSelectedScaleY),dropSelectedPositionPage.x2=positionPage.x,dropSelectedPositionPage.y2=positionPage.y}(dropSelectedData=$dropNode.attr("data"))&&(dropSelectedData=JSON.parse(dropSelectedData)),compSelectedDimensionWidth=(compSelectedDimensionWidth=parseFloat($dropNode.attr("dimensionwidth")))>0?compSelectedDimensionWidth:void 0,compSelectedDimensionHeight=(compSelectedDimensionHeight=parseFloat($dropNode.attr("dimensionheight")))>0?compSelectedDimensionHeight:void 0,compSelectedDimensionFixed="true"===$dropNode.attr("dimensionfixed"),compSelectedDimensionNoSize="true"===$dropNode.attr("dimensionnosize"),compSelectedForceTop="true"===$dropNode.attr("forcetop"),compSelectedForceBottom="true"===$dropNode.attr("forcebottom"),"component"===compSelectedType||"furniture"===compSelectedType?(uiToolCurrent="comp.selected",svgDropOrient($compSelected,dropSelectedPositionPlan.x1,dropSelectedPositionPlan.y1,compSelectedRotation,compSelectedScaleX,compSelectedScaleY,compSelectedDimensionWidth,compSelectedDimensionHeight,void 0,void 0),componentHaloShow()):"note"===compSelectedType?(uiToolCurrent="note.selected",dropNoteBarShow()):"line"===compSelectedType&&(uiToolCurrent="line.selected",dropLineBarShow())}function componentHaloOrientComp(radians,planScaleX,planScaleY){var $gHaloComp=$("#gHaloCompHolder").find(">g"),scalePlanZoom=svgPlanZoomFinalizedScale/svgPlanZoom100AbsoluteScale,scaleCompInHalo=svgDropGetPlanScale(compSelectedType,planScaleX,planScaleY);scaleCompInHalo.x*=1*scalePlanZoom,scaleCompInHalo.y*=1*scalePlanZoom,compSelectedFlippedH&&(scaleCompInHalo.x=-1*scaleCompInHalo.x),compSelectedFlippedV&&(scaleCompInHalo.y=-1*scaleCompInHalo.y);var planFlippedH="true"===$dataInfo.attr("flippedh"),planFlippedV="true"===$dataInfo.attr("flippedv");(planFlippedH&&!planFlippedV||planFlippedV&&!planFlippedH)&&(radians*=-1),mx=xfrmMatrixGetDefault();var haloX=compHaloCurrentWidth/2-COMP_ICON_WIDTH/2*scaleCompInHalo.x,haloY=compHaloCurrentHeight/2-COMP_ICON_HEIGHT/2*scaleCompInHalo.y;mx=xfrmMatrixMoveAbsolute(mx,haloX,haloY),mx=xfrmMatrixRotate(mx,radians,COMP_ICON_WIDTH/2*scaleCompInHalo.x,COMP_ICON_HEIGHT/2*scaleCompInHalo.y),mx=xfrmMatrixScale(mx,scaleCompInHalo.x,scaleCompInHalo.y),xfrmSVGSet($gHaloComp,mx)}function componentHaloOrientUI(centerX,centerY,compWidth,compHeight){dbg("componentHaloOrientUI(centerX, centerY, compWidth, compHeight) = "+centerX+","+centerY+","+compWidth+","+compHeight);var $divStage=$("#divStage"),$divHalo=$("#divHalo"),$svgHalo=$("#svgHalo"),$gHaloCompHolder=$svgHalo.find("#gHaloCompHolder"),$gHaloBkgrndMainRect=$svgHalo.find("#gHaloBkgrndMain").children("rect").first(),$gHaloBkgrndBottomRect=$svgHalo.find("#gHaloBkgrndBottom").children("rect").first(),$gHaloOutlineRect=$svgHalo.find("#gHaloOutline").children("rect").first(),$gHaloBtnsDelete=$svgHalo.find("#gHaloBtnsDelete"),$gHaloBtnsRotate=$svgHalo.find("#gHaloBtnsRotate"),$gHaloBtnsResize=$svgHalo.find("#gHaloBtnsResize"),$gHaloElsDimens=$svgHalo.find('[id^="gHaloSize"]'),$gHaloElsActiveRotate=$svgHalo.find("#gHaloActiveRotate"),haloWidth=compWidth+2*COMP_HALO_MARGIN_BTNS,haloHeight=compHeight+2.5*COMP_HALO_MARGIN_BTNS,haloFullWidth=(haloWidth=haloWidth>COMP_HALO_MIN_WIDTH?haloWidth:COMP_HALO_MIN_WIDTH)+2*COMP_HALO_MARGIN_BTNS,haloFullHeight=(haloHeight=haloHeight>COMP_HALO_MIN_HEIGHT?haloHeight:COMP_HALO_MIN_HEIGHT)+2*COMP_HALO_MARGIN_BTNS;haloFullWidth>haloFullHeight?haloFullHeight=haloFullWidth:haloFullWidth=haloFullHeight,$svgHalo.attr("width",haloFullWidth),$svgHalo.attr("height",haloFullHeight);var mx,posCenterX=haloFullWidth/2,posCenterY=haloFullHeight/2,posLeft=haloFullWidth/2-haloWidth/2,posTop=haloFullHeight/2-haloHeight/2,posTopLowerBkgrnd=posTop+haloHeight-COMP_HALO_MARGIN_BTNS,btnsLeft=posLeft+COMP_HALO_MARGIN_BTNS/2,btnsRight=posLeft+haloWidth-COMP_HALO_MARGIN_BTNS/2,btnsTop=posTop+COMP_HALO_MARGIN_BTNS/2,btnsBottom=posTop+haloHeight-COMP_HALO_MARGIN_BTNS/2;$gHaloCompHolder.attr("width",haloFullWidth),$gHaloCompHolder.attr("height",haloFullHeight),$gHaloBkgrndMainRect.add($gHaloOutlineRect).attr("x",posLeft),$gHaloBkgrndMainRect.add($gHaloOutlineRect).attr("y",posTop),$gHaloBkgrndMainRect.add($gHaloOutlineRect).attr("width",haloWidth),$gHaloBkgrndMainRect.add($gHaloOutlineRect).attr("height",haloHeight),$gHaloBkgrndBottomRect.attr("x",posLeft),$gHaloBkgrndBottomRect.attr("y",posTopLowerBkgrnd),$gHaloBkgrndBottomRect.attr("width",haloWidth),$gHaloBkgrndBottomRect.attr("height",COMP_HALO_MARGIN_BTNS),mx=xfrmSVGGet($gHaloBtnsRotate),mx=xfrmMatrixMoveAbsolute(mx,btnsLeft,btnsBottom),xfrmSVGSet($gHaloBtnsRotate,mx),mx=xfrmSVGGet($gHaloBtnsDelete),mx=xfrmMatrixMoveAbsolute(mx,btnsRight,btnsTop),xfrmSVGSet($gHaloBtnsDelete,mx),mx=xfrmSVGGet($gHaloBtnsResize),mx=xfrmMatrixMoveAbsolute(mx,btnsRight,btnsBottom),xfrmSVGSet($gHaloBtnsResize,mx),mx=xfrmSVGGet($gHaloElsDimens),mx=xfrmMatrixMoveAbsolute(mx,posCenterX,btnsBottom),xfrmSVGSet($gHaloElsDimens,mx),mx=xfrmMatrixGetDefault(),mx=xfrmMatrixMoveAbsolute(mx,btnsLeft,btnsBottom),xfrmSVGSet($gHaloElsActiveRotate,mx),$gHaloElsActiveRotate.hide();var haloX=centerX,haloY=centerY;haloX-=$divStage.offset().left,haloY-=$divStage.offset().top,haloX-=haloFullWidth/2,haloY-=haloFullHeight/2,$divHalo.css("left",haloX+"px"),$divHalo.css("top",haloY+"px"),compHaloRotatorPageCenterX=centerX,compHaloRotatorPageCenterY=centerY,compHaloRotatorPageX=centerX-haloFullWidth/2+btnsLeft,compHaloRotatorPageY=centerY-haloFullHeight/2+btnsBottom,dbg("compHaloRotatorPageCenterX, compHaloRotatorPageCenterY: "+compHaloRotatorPageCenterX+", "+compHaloRotatorPageCenterY),dbg("compHaloRotatorPageX, compHaloRotatorPageY: "+compHaloRotatorPageX+", "+compHaloRotatorPageY),compHaloRotatorDefaultRadians=Math.atan2(compHaloRotatorPageX-compHaloRotatorPageCenterX,-(compHaloRotatorPageY-compHaloRotatorPageCenterY)),compHaloRotatorCenterOffsetX=posCenterX-btnsLeft,compHaloRotatorCenterOffsetY=posCenterY-btnsBottom,compHaloCurrentWidth=haloFullWidth,compHaloCurrentHeight=haloFullHeight}function componentHaloShow(){dbg("componentHaloShow");var $divHalo=$("#divHalo"),$svgHalo=$("#svgHalo"),$gHaloCompHolder=$("#gHaloCompHolder");$gHaloCompHolder.empty();var compBounds=$compSelected[0].getBoundingClientRect();componentHaloOrientUI(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,compBounds.width,compBounds.height),compSelectedRotationOriginal=compSelectedRotation;var $gHaloComp=$compSelected.clone(!1,!1);"furniture"===compSelectedType?COMP_FURNITURE_COLOR_ACTIVE!==COMP_COLOR_UNDEFINED?svgHighlightAnyStroke($gHaloComp,COMP_FURNITURE_COLOR_ACTIVE):COMP_FURNITURE_COLOR_PLACED!==COMP_COLOR_UNDEFINED&&svgHighlightAnyStroke($gHaloComp,COMP_FURNITURE_COLOR_PLACED):COMP_COLOR_ACTIVE!==COMP_COLOR_UNDEFINED?svgHighlightAnyStroke($gHaloComp,COMP_COLOR_ACTIVE):COMP_COLOR_PLACED!==COMP_COLOR_UNDEFINED&&svgHighlightAnyStroke($gHaloComp,COMP_COLOR_PLACED),$gHaloCompHolder.append($gHaloComp),$gHaloComp.contents().off(),$gHaloComp.attr("class",""),componentHaloOrientComp(compSelectedRotation,compSelectedScaleX,compSelectedScaleY),$compSelected.hide();var $txtWidth=$svgHalo.find("#gHaloSizeWidth").children("text"),$txtHeight=$svgHalo.find("#gHaloSizeHeight").children("text");dataCompMetric?($txtWidth.text(Math.round(2.54*compSelectedDimensionWidth)),$txtHeight.text(Math.round(2.54*compSelectedDimensionHeight))):($txtWidth.text(compSelectedDimensionWidth),$txtHeight.text(compSelectedDimensionHeight));var $gHaloBkgrnds=$svgHalo.find("#gHaloBkgrndMain").add($svgHalo.find("#gHaloBkgrndBottom"));$gHaloBkgrnds.hammer(),$gHaloBkgrnds.data("hammer").get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0}),$gHaloBkgrnds.on("pan panstart",componentHaloDrag),$gHaloBkgrnds.on("panend",componentHaloDragStop),$gHaloBkgrnds.on("tap",componentHaloDragStop),$gHaloComp.hammer(),$gHaloComp.data("hammer").get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0}),$gHaloComp.on("pan panstart",componentHaloDrag),$gHaloComp.on("panend",componentHaloDragStop),$gHaloComp.on("tap",componentHaloDragStop);var $gHaloBtnsDelete=$svgHalo.find("#gHaloBtnsDelete");$gHaloBtnsDelete.contents().on("mouseenter mouseleave",componentHaloDeleteMouseover),$gHaloBtnsDelete.contents().on("tap",componentHaloDelete);var $gHaloBtnsResize=$svgHalo.find("#gHaloBtnsResize"),$gHaloBtnsSize=$svgHalo.find('[id^="gHaloSize"]');compSelectedDimensionNoSize?($gHaloBtnsResize.hide(),$gHaloBtnsSize.hide(),$gHaloBtnsSize.contents().off()):compSelectedDimensionFixed?($gHaloBtnsResize.hide(),$gHaloBtnsSize.contents().off(),$gHaloBtnsSize.contents().on("mousedown touch MSPointerDown",componentHaloDrag)):($gHaloBtnsResize.show(),$gHaloBtnsSize.show(),$gHaloBtnsSize.contents().on("mouseenter mouseleave",componentHaloSizeMouseover),$gHaloBtnsSize.contents().on("tap",componentHaloSize));var $gHaloBtnsRotate=$svgHalo.find("#gHaloBtnsRotate");$gHaloBtnsRotate.hammer(),$gHaloBtnsRotate.data("hammer").get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0}),$gHaloBtnsRotate.on("pan panstart",componentHaloRotate),$gHaloBtnsRotate.on("panend",componentHaloRotateStop),$gHaloBtnsRotate.on("tap",componentHaloRotateStop),$divHalo.on("tap",componentHaloSave),$divHalo.show();var $blocker=uiBlockMainUI(!0,!0);$blocker.on("tap",componentHaloSave),($blocker=uiBlockStage(!0,!1)).on("tap",componentHaloSave)}function componentHaloHide(){dbg("componentHaloHide");var $divHalo=$("#divHalo"),$svgHalo=$("#svgHalo");$divHalo.hide(),$divHalo.off("tap",componentHaloSave),$("#gHaloCompHolder").children("g").first().remove(),$svgHalo.find("#gHaloBkgrndMain").add($svgHalo.find("#gHaloBkgrndBottom")).contents().off();var $gHaloBtnsDelete=$svgHalo.find("#gHaloBtnsDelete");$gHaloBtnsDelete.contents().off(),svgHighlight($gHaloBtnsDelete,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR);var $gHaloBtnsSize=$svgHalo.find('[id^="gHaloSize"]');$gHaloBtnsSize.contents().off(),svgHighlight($gHaloBtnsSize,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR);var $gHaloBtnsRotate=$svgHalo.find("#gHaloBtnsRotate");$gHaloBtnsRotate.contents().off(),svgHighlight($gHaloBtnsRotate,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR);var mx=xfrmMatrixGetDefault();xfrmSVGSet($gHaloBtnsRotate,mx);var $blocker=uiBlockMainUI(!1,void 0);$blocker.off("tap",componentHaloSave),($blocker=uiBlockStage(!1,void 0)).off("tap",componentHaloSave)}function componentHaloSaveMouseover(e){var $node=$("#svgHalo").find("#gHaloBtnsSave");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function componentHaloDeleteMouseover(e){var $node=$("#svgHalo").find("#gHaloBtnsDelete");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function componentHaloRotateMouseover(e){var $node=$("#svgHalo").find("#gHaloBtnsRotate");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function componentHaloSizeMouseover(e){var $node=$("#svgHalo").find("#gHaloSize");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function componentHaloSave(){if(dbg("componentHaloSave()"),killEvent(void 0,!0),$compSelected){svgDropOrient($compSelected,void 0,void 0,compSelectedRotation,compSelectedScaleX,compSelectedScaleY,void 0,void 0,dropSelectedPositionPage.x1,dropSelectedPositionPage.y1),svgDropSave($compSelected),$compSelected.show(),"furniture"===compSelectedType?COMP_FURNITURE_COLOR_PLACED!==COMP_COLOR_UNDEFINED&&svgHighlightAnyStroke($compSelected,COMP_FURNITURE_COLOR_PLACED):COMP_COLOR_PLACED!==COMP_COLOR_UNDEFINED&&svgHighlightAnyStroke($compSelected,COMP_COLOR_PLACED),$compSelected=void 0,componentHaloHide();var $compDropNode=$dataViews.find("drop[dropid="+dropSelectedDropID+"]"),coordsPlan=svgDropGetCoordsForPlan(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,$compDropNode.attr("type"),compSelectedScaleX,compSelectedScaleY);dropSelectedPositionPlan.x1=coordsPlan.x,dropSelectedPositionPlan.y1=coordsPlan.y,$compDropNode.attr("position",JSON.stringify(dropSelectedPositionPlan)),void 0!==compSelectedRotation&&$compDropNode.attr("rotation",compSelectedRotation),void 0!==compSelectedScaleX&&$compDropNode.attr("scalex",compSelectedScaleX),void 0!==compSelectedScaleY&&$compDropNode.attr("scaley",compSelectedScaleY),void 0!==compSelectedDimensionWidth&&$compDropNode.attr("dimensionwidth",compSelectedDimensionWidth),void 0!==compSelectedDimensionHeight&&$compDropNode.attr("dimensionheight",compSelectedDimensionHeight),void 0!==compSelectedDimensionFixed&&$compDropNode.attr("dimensionfixed",compSelectedDimensionFixed),void 0!==compSelectedDimensionNoSize&&$compDropNode.attr("dimensionnosize",compSelectedDimensionNoSize),void 0!==compSelectedForceTop&&$compDropNode.attr("forcetop",compSelectedForceTop),void 0!==compSelectedForceBottom&&$compDropNode.attr("forcebottom",compSelectedForceBottom)}}function componentHaloDelete(){dbg("componentHaloDelete"),svgDropDelete($compSelected),$compSelected=void 0,componentHaloHide(),$dataViews.find("drop[dropid="+dropSelectedDropID+"]").remove()}function componentHaloSize(e){dbg("componentHaloSize");var $divDialogHaloSize=$("#layoutDialogHaloSize"),$svgHalo=$("#svgHalo");$divDialogHaloSize.find("#txtHaloSizeWidth").val($svgHalo.find("#gHaloSizeWidth").children("text").text()),$divDialogHaloSize.find("#txtHaloSizeHeight").val($svgHalo.find("#gHaloSizeHeight").children("text").text());var $txtWidth=$divDialogHaloSize.find("#txtHaloSizeWidth"),$txtHeight=$divDialogHaloSize.find("#txtHaloSizeHeight");return $txtWidth.val(""),$txtHeight.val(""),$txtWidth.attr("placeholder",$svgHalo.find("#gHaloSizeWidth").children("text").text()),$txtHeight.attr("placeholder",$svgHalo.find("#gHaloSizeHeight").children("text").text()),$divDialogHaloSize.popup("open",{x:0,y:0}),killEvent(e)}function componentHaloSizeCancel(){return $("#layoutDialogHaloSize").popup("close"),killEvent(void 0,!0)}function componentHaloSizeGo(){dbg("componentHaloSizeGo");var $divDialogHaloSize=$("#layoutDialogHaloSize");$divDialogHaloSize.popup("close");var $txtWidth=$divDialogHaloSize.find("#txtHaloSizeWidth"),$txtHeight=$divDialogHaloSize.find("#txtHaloSizeHeight"),newWidth=$txtWidth.val(),newHeight=$txtHeight.val();newWidth=newWidth||$txtWidth.attr("placeholder"),newHeight=newHeight||$txtHeight.attr("placeholder");var $svgHalo=$("#svgHalo");$svgHalo.find("#gHaloSizeWidth").children("text").text(newWidth),$svgHalo.find("#gHaloSizeHeight").children("text").text(newHeight),dataCompMetric&&(newWidth/=2.54,newHeight/=2.54),componentHaloOrientComp(compSelectedRotation,compSelectedScaleX*=newWidth/compSelectedDimensionWidth,compSelectedScaleY*=newHeight/compSelectedDimensionHeight);var compBounds=$("#gHaloCompHolder > g")[0].getBoundingClientRect();return componentHaloOrientUI(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,compBounds.width,compBounds.height),componentHaloOrientComp(compSelectedRotation,compSelectedScaleX,compSelectedScaleY),compSelectedDimensionWidth=newWidth,compSelectedDimensionHeight=newHeight,killEvent(void 0,!0)}function componentHaloRotate(e){dbg("componentHaloRotate e.type = "+e.type);var pageX,pageY,$gHaloBtnRotate=$("#gHaloBtnsRotate"),$gHaloActiveRotate=$("#gHaloActiveRotate"),$gHaloComp=$("#gHaloCompHolder").children("g").first();isTouchEvent(e);if(e.originalEvent&&(e=e.originalEvent),e.preventDefault(),pageX=e.gesture.center.x,pageY=e.gesture.center.y,"panstart"===e.type){compSelectedTmpMX=xfrmSVGGet($gHaloComp),compHaloRotatorDefaultMX=xfrmSVGGet($gHaloActiveRotate);var deltaX=compHaloRotatorPageX-compHaloRotatorPageCenterX,deltaY=compHaloRotatorPageY-compHaloRotatorPageCenterY;dbg(compHaloRotatorPageX-pageX+", "+(compHaloRotatorPageY-pageY));var $svgHalo=$("#svgHalo"),$gHaloBtnsResize=$svgHalo.find("#gHaloBtnsResize"),$gHaloBtnsSize=$svgHalo.find('[id^="gHaloSize"]'),$elsFade=$svgHalo.children().not("#gHaloCompHolder").not($gHaloActiveRotate);compSelectedDimensionNoSize?$elsFade=$elsFade.not($gHaloBtnsResize).not($gHaloBtnsSize):compSelectedDimensionFixed&&($elsFade=$elsFade.not($gHaloBtnsResize)),$elsFade.fadeTo(100,.25),$gHaloActiveRotate.show(),$gHaloBtnRotate.off("mouseleave",componentHaloRotateMouseover),svgHighlight($gHaloBtnRotate,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER)}else if(pageX&&pageY){deltaX=pageX-compHaloRotatorPageCenterX,deltaY=pageY-compHaloRotatorPageCenterY;var radiansHaloRotator=Math.atan2(deltaX,-deltaY)-compHaloRotatorDefaultRadians;radiansHaloRotator-=radiansHaloRotator%(COMP_HALO_ROTATOR_STEP_ANGLE*Math.PI/180);var mx=compHaloRotatorDefaultMX;mx=xfrmMatrixRotate(mx,radiansHaloRotator,compHaloRotatorCenterOffsetX,compHaloRotatorCenterOffsetY),xfrmSVGSet($gHaloActiveRotate,mx);var planFlippedH="true"===$dataInfo.attr("flippedh"),planFlippedV="true"===$dataInfo.attr("flippedv");(planFlippedH&&!planFlippedV||planFlippedV&&!planFlippedH)&&(radiansHaloRotator*=-1),componentHaloOrientComp(compSelectedRotation=compSelectedRotationOriginal+radiansHaloRotator,compSelectedScaleX,compSelectedScaleY)}return killEvent(e)}function componentHaloRotateStop(e){dbg("componentHaloRotateStop"),e.preventDefault();var $gHaloBtnsRotate=$("#gHaloBtnsRotate"),$gHaloActiveRotate=$("#gHaloActiveRotate");compSelectedRotationOriginal=compSelectedRotation;var $svgHalo=$("#svgHalo"),$gHaloBtnsResize=$svgHalo.find("#gHaloBtnsResize"),$gHaloBtnsSize=$svgHalo.find('[id^="gHaloSize"]'),$elsFade=$svgHalo.children().not("#gHaloCompHolder").not($gHaloActiveRotate);compSelectedDimensionNoSize?$elsFade=$elsFade.not($gHaloBtnsResize).not($gHaloBtnsSize):compSelectedDimensionFixed&&($elsFade=$elsFade.not($gHaloBtnsResize)),$elsFade.fadeTo(100,1),$gHaloBtnsRotate.on("mouseleave",componentHaloRotateMouseover),svgHighlight($gHaloBtnsRotate,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$("#svgHalo").find("#gHaloBkgrnd").contents().on("touch",componentHaloDrag),componentHaloOrientComp(compSelectedRotation,compSelectedScaleX,compSelectedScaleY);var compBounds=$("#gHaloCompHolder > g")[0].getBoundingClientRect();return componentHaloOrientUI(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,compBounds.width,compBounds.height),componentHaloOrientComp(compSelectedRotation,compSelectedScaleX,compSelectedScaleY),killEvent(e)}function componentHaloDrag(e){dbg("componentHaloDrag e.type = "+e.type);var $divHalo=$("#divHalo"),$divStage=$("#divStage"),eType=(isTouchEvent(e),e.type?e.type:e.gesture.type);e.originalEvent&&(e=e.originalEvent),e.preventDefault();var pageX,pageY;$(e.target);if(pageX=e.gesture.center.x,pageY=e.gesture.center.y,"panstart"===eType)compHaloCurrentDragOffsetX=pageX-$divHalo.offset().left-compHaloCurrentWidth/2,compHaloCurrentDragOffsetY=pageY-$divHalo.offset().top-compHaloCurrentHeight/2;else if("pan"===eType&&pageX&&pageY){pageY-=compHaloCurrentDragOffsetY;var haloX=(pageX-=compHaloCurrentDragOffsetX)-$divStage.offset().left-compHaloCurrentWidth/2,haloY=pageY-$divStage.offset().top-compHaloCurrentHeight/2;$divHalo.css("left",haloX+"px"),$divHalo.css("top",haloY+"px"),dropSelectedPositionPage.x1=pageX,dropSelectedPositionPage.y1=pageY;var compPlanPos=svgDropGetCoordsForPlan(pageX,pageY,compSelectedType,compSelectedScaleX,compSelectedScaleY);dropSelectedPositionPlan.x1=compPlanPos.x,dropSelectedPositionPlan.y1=compPlanPos.y}return killEvent(e)}function componentHaloDragStop(e){dbg("componentHaloDragStop"),e.preventDefault(),componentHaloOrientComp(compSelectedRotation,compSelectedScaleX,compSelectedScaleY);var compBounds=$("#gHaloCompHolder > g")[0].getBoundingClientRect();return componentHaloOrientUI(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,compBounds.width,compBounds.height),componentHaloOrientComp(compSelectedRotation,compSelectedScaleX,compSelectedScaleY),killEvent(e)}function componentGetDimensions(compDBID){var compSVGID=$dataComponents.find('component[id="'+compDBID+'"]').attr("svgid"),compDimensInfo={width:0,height:0,fixed:!1,nosize:!1,forcetop:!1,forcebottom:!1};if((compSVGID=compSVGID.split(".")).length>3&&(compDimensInfo.fixed=-1!==compSVGID[3].indexOf("fixed"),compDimensInfo.nosize=-1!==compSVGID[3].indexOf("nosize"),compDimensInfo.forcetop=-1!==compSVGID[3].indexOf("top"),compDimensInfo.forcebottom=-1!==compSVGID[3].indexOf("bottom")),(compSVGID=compSVGID[2])&&-1!==compSVGID.indexOf("x")){var compDimens=compSVGID.split("x");if(2===compDimens.length)compDimensInfo.width=parseFloat(compDimens[0]),compDimensInfo.height=parseFloat(compDimens[1]);else{var strWarning="comp naming error type 2. compDBID="+compDBID+", compSVGID="+compSVGID;dbg(strWarning),console.warn(strWarning)}}else{strWarning="comp naming error type 1. compDBID="+compDBID+", compSVGID="+compSVGID;dbg(strWarning),console.warn(strWarning)}return compDimensInfo}function dropNoteStart(){dbg("dropNoteStart()"),uiToolCurrent="note.add",compSelectedType="note",dropSelectedDropID=dataDropCounter++,$("#btnNoteTool").addClass("ui-btn-active").addClass("ui-state-persist"),killEvent(void 0,!0),$(document).on("mouseup touchend",dropNoteAdd),uiStatusMsg("Click anywhere on the plan to place your note.",!0),$("#divStageBlocker").css("cursor","crosshair"),uiBlockMainUI(!0,!0),uiBlockStage(!0,!1)}function dropNoteFinish(){uiToolCurrent=void 0,$("#btnNoteTool").removeClass("ui-btn-active").removeClass("ui-state-persist"),$(document).off("mouseup touchend",dropNoteAdd),uiStatusMsgClear();var $gMove=$("#gNoteBarMove");$gMove.contents().off(),svgHighlight($gMove,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR);var $gEdit=$("#gNoteBarEdit");$gEdit.contents().off(),svgHighlight($gEdit,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR);var $gSave=$("#gNoteBarSave");$gSave.contents().off(),svgHighlight($gSave,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR);var $gDelete=$("#gNoteBarDelete");$gDelete.contents().off(),svgHighlight($gDelete,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$("#divNoteBar").hide(),$("#txtNote").val(""),$("#divStageBlocker").css("cursor",""),uiBlockMainUI(!1,void 0),uiBlockStage(!1,void 0)}function dropNoteAdd(e){var pageX,pageY;dbg("dropNoteAdd(e) = "+e.type),e.originalEvent&&(e=e.originalEvent),e.changedTouches&&e.changedTouches.length>0?(pageX=e.changedTouches[0].pageX,pageY=e.changedTouches[0].pageY):(pageX=e.pageX,pageY=e.pageY),planIsPointOnVisiblePlan(pageX,pageY)&&($(document).off("mouseup touchend",dropNoteAdd),dropSelectedPositionPage.x1=pageX,dropSelectedPositionPage.y1=pageY,setTimeout("$('#layoutDialogNote').popup('open');",500))}function dropNoteBarEditTxt(){dbg("dropNoteBarEditTxt()"),uiToolCurrent="note.edit",$("#txtNote").val(dropSelectedData.text),setTimeout("$('#layoutDialogNote').popup('open');",500)}function dropNoteBarEditTxtSave(){dbg("dropNoteBarEditTxtSave()");var txt=$("#txtNote").val();if(""!==txt)if(dropSelectedData={text:txt},"note.add"===uiToolCurrent){var compPlanPos=svgDropGetCoordsForPlan(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,compSelectedType,compSelectedScaleX,compSelectedScaleY);dropSelectedPositionPlan.x1=compPlanPos.x,dropSelectedPositionPlan.y1=compPlanPos.y,dropNodeAdd(uiViewsCurrentID,compSelectedType,dropSelectedDropID,dropSelectedPositionPlan,0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,dropSelectedData),$(document).off("mouseup touchend",dropNoteAdd),uiStatusMsgClear(),svgDropCreateNote(txt,uiViewsCurrentID,dropSelectedDropID,dropSelectedPositionPlan.x1,dropSelectedPositionPlan.y1,0,!0)}else svgDropUpdateProperties($compSelected,txt);else"note.add"===uiToolCurrent?($(document).off("mouseup touchend",dropNoteAdd),uiStatusMsgClear()):dropNoteBarDelete()}function dropNoteBarEditTxtCancel(){"note.add"===uiToolCurrent&&dropNoteFinish()}function dropNoteBarShow(){dbg("dropNoteBarShow()");var $divStage=$("#divStage"),$divNoteBar=$("#divNoteBar"),barX=dropSelectedPositionPage.x1-$divStage.offset().left,barY=dropSelectedPositionPage.y1-$divStage.offset().top-DROP_NOTEBAR_HEIGHT;$divNoteBar.css("left",barX+"px"),$divNoteBar.css("top",barY+"px"),$divNoteBar.show();var $gMove=$("#gNoteBarMove");svgHighlight($gMove,COMP_HALO_COLOR_BASE,COMP_HALO_COLOR),$gMove.contents().on("mouseenter mouseleave",dropNoteBarMoveMouseover),$gMove.hammer(),$gMove.data("hammer").get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0}),$gMove.on("pan panstart",dropNoteBarDrag);var $gEdit=$("#gNoteBarEdit");svgHighlight($gEdit,COMP_HALO_COLOR_BASE,COMP_HALO_COLOR),$gEdit.contents().on("mouseenter mouseleave",dropNoteBarEditMouseover),$gEdit.contents().on("tap",dropNoteBarEditTxt);var $gSave=$("#gNoteBarSave");svgHighlight($gSave,COMP_HALO_COLOR_BASE,COMP_HALO_COLOR),$gSave.contents().on("mouseenter mouseleave",dropNoteBarSaveMouseover),$gSave.contents().on("tap",dropNoteBarSave);var $gDelete=$("#gNoteBarDelete");svgHighlight($gDelete,COMP_HALO_COLOR_BASE,COMP_HALO_COLOR),$gDelete.contents().on("mouseenter mouseleave",dropNoteBarDeleteMouseover),$gDelete.contents().on("tap",dropNoteBarDelete),$divNoteBar.show(),dbg($divNoteBar.attr("style")),$("#divStageBlocker").css("cursor",""),uiBlockMainUI(!0,!0),uiBlockStage(!0,!1)}function dropNoteBarSave(){dropNodeEdit(dropSelectedDropID,dropSelectedPositionPlan,0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,dropSelectedData),svgDropSave($compSelected),$compSelected=void 0,dropNoteFinish()}function dropNoteBarDelete(){svgDropDelete($compSelected),$compSelected=void 0,$dataViews.find("drop[dropid="+dropSelectedDropID+"]").remove(),dropNoteFinish()}function dropNoteBarDrag(e){var pageX,pageY;if(dbg("dropNoteBarDrag"),e.originalEvent&&(e=e.originalEvent),e.preventDefault(),pageX=e.gesture.center.x,pageY=e.gesture.center.y,pageX&&pageY){var $divStage=$("#divStage"),$divNoteBar=$("#divNoteBar"),barX=pageX-$divStage.offset().left-DROP_NOTEBAR_DRAG_OFFSET_X,barY=pageY-$divStage.offset().top-DROP_NOTEBAR_DRAG_OFFSET_Y;$divNoteBar.css("left",barX+"px"),$divNoteBar.css("top",barY+"px"),dropSelectedPositionPage.x1=pageX-DROP_NOTEBAR_DRAG_OFFSET_X,dropSelectedPositionPage.y1=pageY+DROP_NOTEBAR_HEIGHT-DROP_NOTEBAR_DRAG_OFFSET_Y;var compPlanPos=svgDropGetCoordsForPlan(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,compSelectedType,compSelectedScaleX,compSelectedScaleY);dropSelectedPositionPlan.x1=compPlanPos.x,dropSelectedPositionPlan.y1=compPlanPos.y,svgDropOrient($compSelected,dropSelectedPositionPlan.x1,dropSelectedPositionPlan.y1,compSelectedRotation,void 0,void 0,void 0,void 0,void 0,void 0)}return killEvent(e)}function dropNoteBarDragStop(e){return dbg("dropNoteBarDragStop"),e.preventDefault(),killEvent(e)}function dropNoteBarMoveMouseover(e){var $node=$("#gNoteBarMove");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function dropNoteBarSaveMouseover(e){var $node=$("#gNoteBarSave");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function dropNoteBarEditMouseover(e){var $node=$("#gNoteBarEdit");e&&"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function dropNoteBarDeleteMouseover(e){var $node=$("#gNoteBarDelete");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function dropLineStart(){uiToolCurrent="line.add.1",compSelectedType="line",dropSelectedDropID=dataDropCounter++,$("#btnLineTool").addClass("ui-btn-active").addClass("ui-state-persist"),killEvent(void 0,!0),$(document).on("mouseup touchend",dropLineAdd),uiStatusMsg("Tap/click a location on the plan to begin your line.",!0),$("#divStageBlocker").css("cursor","crosshair"),uiBlockMainUI(!0,!0),uiBlockStage(!0,!1)}function dropLineFinish(){uiToolCurrent=void 0,$("#btnLineTool").removeClass("ui-btn-active").removeClass("ui-state-persist"),$(document).off("mouseup touchend",dropLineAdd),uiStatusMsgClear(),$("#gLineBarSave").contents().off(),$("#gLineBarDelete").contents().off(),$("#divLineBar").hide(),$("#divLineBar2").hide(),$("#divStageBlocker").css("cursor",""),uiBlockMainUI(!1,void 0),uiBlockStage(!1,void 0)}function dropLineAdd(e){var pageX,pageY;if(dbg("dropLineAdd(e) = "+e.type),e.originalEvent&&(e=e.originalEvent),e.changedTouches&&e.changedTouches.length>0?(pageX=e.changedTouches[0].pageX,pageY=e.changedTouches[0].pageY):(pageX=e.pageX,pageY=e.pageY),planIsPointOnVisiblePlan(pageX,pageY)){if("line.add.1"===uiToolCurrent)uiToolCurrent="line.add.2",dropSelectedPositionPage.x1=pageX,dropSelectedPositionPage.y1=pageY,dbg(dropSelectedPositionPage),dropLineBarShowStartPoint(pageX,pageY),uiStatusMsg("Tap/click a location for the end point.",!0);else{uiToolCurrent="line.selected",dropSelectedPositionPage.x1<pageX?(dropSelectedPositionPage.x2=pageX,dropSelectedPositionPage.y2=pageY):(dropSelectedPositionPage.x2=dropSelectedPositionPage.x1,dropSelectedPositionPage.y2=dropSelectedPositionPage.y1,dropSelectedPositionPage.x1=pageX,dropSelectedPositionPage.y1=pageY);var compPlanPos=svgDropGetCoordsForPlan(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1,compSelectedType,compSelectedScaleX,compSelectedScaleY);dropSelectedPositionPlan.x1=compPlanPos.x,dropSelectedPositionPlan.y1=compPlanPos.y,compPlanPos=svgDropGetCoordsForPlan(dropSelectedPositionPage.x2,dropSelectedPositionPage.y2,compSelectedType,compSelectedScaleX,compSelectedScaleY),dropSelectedPositionPlan.x2=compPlanPos.x,dropSelectedPositionPlan.y2=compPlanPos.y,dropNodeAdd(uiViewsCurrentID,compSelectedType,dropSelectedDropID,dropSelectedPositionPlan,0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,void 0),svgDropCreateLine(uiViewsCurrentID,dropSelectedDropID,dropSelectedPositionPlan,0,!1),dropLineFinish()}return killEvent(e,!0)}}function dropLineBarShow(){dropLineBarShowStartPoint(dropSelectedPositionPage.x1,dropSelectedPositionPage.y1);var $divStage=$("#divStage"),$divLineBar=$("#divLineBar"),barX=dropSelectedPositionPage.x2-$divStage.offset().left-4,barY=dropSelectedPositionPage.y2-$divStage.offset().top-17;$divLineBar.css("left",barX+"px"),$divLineBar.css("top",barY+"px");var $gSave=$("#gLineBarSave");svgHighlight($gSave,COMP_HALO_COLOR_BASE,COMP_HALO_COLOR),$gSave.contents().on("mouseenter mouseleave",dropLineBarSaveMouseover),$gSave.contents().on("tap",dropLineBarSave);var $gDelete=$("#gLineBarDelete");svgHighlight($gDelete,COMP_HALO_COLOR_BASE,COMP_HALO_COLOR),$gDelete.contents().on("mouseenter mouseleave",dropLineBarDeleteMouseover),$gDelete.contents().on("tap",dropLineBarDelete),$divLineBar.show(),uiBlockMainUI(!0,!0),uiBlockStage(!0,!1)}function dropLineBarShowStartPoint(pageX,pageY){dbg("dropLineBarShowStartPoint(pageX, PaygeY) = "+pageX+","+pageY);var $divStage=$("#divStage"),$divLineBar2=$("#divLineBar2"),barX=pageX-$divStage.offset().left-4,barY=pageY-$divStage.offset().top-17;$divLineBar2.css("left",barX+"px"),$divLineBar2.css("top",barY+"px"),$divLineBar2.show()}function dropLineBarSave(){svgDropSave($compSelected),dropLineFinish()}function dropLineBarDelete(){svgDropDelete($compSelected),$dataViews.find("drop[dropid="+dropSelectedDropID+"]").remove(),dropLineFinish()}function dropLineBarDrag(e){var pageX,pageY;if("touch"===e.type)e.gesture.preventDefault(),$(document).on("mouseup touchcancel touchend",dropLineBarDragStop),$(document).on("mousemove touchmove",dropLineBarDrag);else if(e.originalEvent&&(e=e.originalEvent),pageX=e.pageX,pageY=e.pageY,pageX&&pageY){var $divStage=$("#divStage"),$divBar=$("#divLineBar"),barX=pageX-$divStage.offset().left-DROP_LINEBAR_DRAG_OFFSET_X,barY=pageY-$divStage.offset().top-DROP_LINEBAR_DRAG_OFFSET_Y;$divBar.css("left",barX+"px"),$divBar.css("top",barY+"px");var compPlanPos=svgDropGetCoordsForPlan(pageX-DROP_LINEBAR_DRAG_OFFSET_X,pageY+DROP_LINEBAR_DRAG_OFFSET_Y,compSelectedType,compSelectedScaleX,compSelectedScaleY);compSelectedPlanX=compPlanPos.x,compSelectedPlanY=compPlanPos.y,svgDropOrient($compSelected,0,0,0,void 0,void 0,void 0,void 0,void 0,void 0)}}function dropLineBarDragStop(e){$(document).off("mouseup touchcancel touchend",dropLineBarDragStop),$(document).off("mousemove touchmove",dropLineBarDrag)}function dropLineBarSaveMouseover(e){var $node=$("#gLineBarSave");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function dropLineBarDeleteMouseover(e){var $node=$("#gLineBarDelete");"mouseenter"===e.type?(svgHighlight($node,COMP_HALO_COLOR,COMP_HALO_COLOR_HOVER),$(e.target).css("cursor","pointer")):"mouseleave"===e.type&&(svgHighlight($node,COMP_HALO_COLOR_HOVER,COMP_HALO_COLOR),$(e.target).css("cursor",""))}function dropNodeAdd(viewID,dropType,dropID,positionPlan,radians,flippedH,flippedV,dimensionWidth,dimensionHeight,dimensionFixed,dimensionNoSize,forceTop,forceBottom,dropData){positionPlan||(positionPlan={}),positionPlan=JSON.stringify(positionPlan),dropData||(dropData={}),dropData=JSON.stringify(dropData);var $node=$("<drop/>");$node.attr("type",dropType),$node.attr("dropid",dropID),$node.attr("position",positionPlan),$node.attr("rotation",radians),$node.attr("flippedh",flippedH),$node.attr("flippedv",flippedV),$node.attr("dimensionwidth",dimensionWidth),$node.attr("dimensionheight",dimensionHeight),$node.attr("dimensionfixed",dimensionFixed),$node.attr("dimensionnosize",dimensionNoSize),$node.attr("forcetop",forceTop),$node.attr("forcebottom",forceBottom),$node.attr("data",dropData),$node.attr("componentid","");var $viewsDropsNode=$dataViews.find("view[id="+viewID+"] drops");$node.appendTo($viewsDropsNode)}function dropNodeEdit(dropID,positionPlan,radians,flippedH,flippedV,dimensionWidth,dimensionHeight,dimensionFixed,dimensionNoSize,forceTop,forceBottom,dropData){dbg("dropNodeEdit(dropID, positionPlan, radians, flippedH, flippedV, dimensionWidth, dimensionHeight, dimensionFixed, dimensionNoSize, forceTop, forceBottom, dropData) = "+dropID+","+positionPlan+","+radians+","+flippedH+","+flippedV+","+dimensionWidth+","+dimensionHeight+","+dimensionFixed+","+dimensionNoSize+","+forceTop+","+forceBottom+","+dropData);var $node=$dataViews.find("drop[dropid="+dropID+"]");positionPlan||(positionPlan={}),positionPlan=JSON.stringify(positionPlan),$node.attr("position",positionPlan),void 0!==radians&&$node.attr("rotation",radians),void 0!==flippedH&&$node.attr("flippedh",flippedH),void 0!==flippedV&&$node.attr("flippedv",flippedV),void 0!==dimensionWidth&&$node.attr("dimensionwidth",dimensionWidth),void 0!==dimensionHeight&&$node.attr("dimensionheight",dimensionHeight),void 0!==dimensionFixed&&$node.attr("dimensionfixedsize",dimensionFixed),void 0!==dimensionNoSize&&$node.attr("dimensionnosize",dimensionNoSize),void 0!==forceTop&&$node.attr("forcetop",forceTop),void 0!==forceBottom&&$node.attr("forcebottom",forceBottom),dropData||(dropData={}),dropData=JSON.stringify(dropData),$node.attr("data",dropData)}