var svgPlanZoom100Width,svgPlanZoom100Height,svgPlanZoom100Left,svgPlanZoom100Top,$svgPlanData,svgPlanZoom100AbsoluteScale=1,svgPlanZoomFinalized=!1,svgPlanZoomFinalizedScale=1;function svgPlanLoad(){dbg("svgPlanLoad()");var url=$dataInfo.attr("svgfile");url?$.ajax({url:url,dataType:"html",async:!1,success:svgPlanParse,error:svgPlanLoadError}):uiSetupAfterTS()}function svgPlanLoadError(jqXHR,textStatus,errorThrown){dbg("svgPlanLoadError()"),uiStatusMsgErr("Error! Could not load the plan: "+jqXHR.responseText),uiSetupAfterTS()}function svgPlanParse(data,textStatus,jqXHR){dbg("svgPlanParse()"),$svgPlanData=$(data);var $divPlan=$("#divPlan"),$divToolbox=$("#divSVGToolbox");planPaperWidth=parseFloat($svgPlanData.find("#area\\.paper > rect").attr("width")),planPaperHeight=parseFloat($svgPlanData.find("#area\\.paper > rect").attr("height")),planPaperAspectRatio=planPaperWidth/planPaperHeight,planWidth=parseFloat($svgPlanData.find("#area\\.plan > rect").attr("width")),planHeight=parseFloat($svgPlanData.find("#area\\.plan > rect").attr("height")),planAspectRatio=planWidth/planHeight,svgPlanPanDisable(),svgPlanTouchZoomDisable(),$divPlan.empty();var $svgPlan=$svgPlanData.clone(!1,!1).empty().attr("id","svgPlan");$svgPlan.attr("shape-rendering","geometricPrecision"),$svgPlan.attr("text-rendering","geometricPrecision"),$svgPlan.attr("style","width:100%; height:100%"),$divToolbox.find("g").clone(!1,!1).empty().attr("id","gPlan").appendTo($svgPlan),$svgPlan.appendTo($divPlan),$svgPlan=void 0,$divPlan.find("svg image").live("dragstart",(function(e){return killEvent(e)})),svgPlanCreateComponentsHolder(),svgPlanZoom("INIT",!0),svgPlanPanEnable(),svgPlanTouchZoomEnable(),uiSetupAfterTS()}function svgPlanCreateComponentsHolder(){var $divToolbox=$("#divSVGToolbox"),$svgPlan=$("#svgPlan"),$gComponents=$divToolbox.find("g").clone(!1,!1);$gComponents.empty().attr("id","gComponents"),$dataViews.find("view[type=svg]").each((function(){var $view=$(this),id="comps_"+$view.attr("id")+"_bottom",$gExistingCompLayer=$gComponents.find('g[id*="_bottom"]').last(),$gNewCompLayer=$divToolbox.find("g").clone(!1,!1).empty().attr("id",id);$gExistingCompLayer.length?$gNewCompLayer.insertAfter($gExistingCompLayer):$gNewCompLayer.prependTo($gComponents),id="comps_"+$view.attr("id")+"_top",$gExistingCompLayer=$gComponents.find('g[id*="_top"]').last(),$gNewCompLayer=$divToolbox.find("g").clone(!1,!1).empty().attr("id",id),$gExistingCompLayer.length?$gNewCompLayer.insertAfter($gExistingCompLayer):$gNewCompLayer.appendTo($gComponents),id="comps_"+$view.attr("id"),$gExistingCompLayer=$gComponents.find('g[id*="_top"]').first(),$gNewCompLayer=$divToolbox.find("g").clone(!1,!1).empty().attr("id",id),$gExistingCompLayer.length?$gNewCompLayer.insertBefore($gExistingCompLayer):$gNewCompLayer.appendTo($gComponents)})),$gComponents.appendTo($svgPlan)}function svgPlanGetCoordsForPlan(pageX,pageY){pageX=parseFloat(pageX),pageY=parseFloat(pageY);var pos={x:0,y:0},$divPlan=$("#divPlan");pageX=parseFloat(pageX),pageY=parseFloat(pageY),pos.x=(pageX-$divPlan.offset().left)*(svgPlanZoom100AbsoluteScale/svgPlanZoomFinalizedScale),pos.y=(pageY-$divPlan.offset().top)*(svgPlanZoom100AbsoluteScale/svgPlanZoomFinalizedScale);var isFlippedH="true"==$dataInfo.attr("flippedh"),isFlippedV="true"==$dataInfo.attr("flippedv");return isFlippedH&&(pos.x=planPaperWidth-pos.x),isFlippedV&&(pos.y=planPaperHeight-pos.y),pos}function svgPlanGetCoordsForPage(planX,planY){planX=parseFloat(planX),planY=parseFloat(planY);var pos={x:0,y:0},$divPlan=$("#divPlan");planX=parseFloat(planX),planY=parseFloat(planY);var isFlippedH="true"==$dataInfo.attr("flippedh"),isFlippedV="true"==$dataInfo.attr("flippedv");return isFlippedH&&(planX=planPaperWidth-planX),isFlippedV&&(planY=planPaperHeight-planY),pos.x=planX/svgPlanZoom100AbsoluteScale*svgPlanZoomFinalizedScale+$divPlan.offset().left,pos.y=planY/svgPlanZoom100AbsoluteScale*svgPlanZoomFinalizedScale+$divPlan.offset().top,pos}function svgPlanFlipOrientText2(){svgPlanFlipOrientText("true"==$dataInfo.attr("flippedh"),"true"==$dataInfo.attr("flippedv"))}function svgPlanFlipOrientText(reverseH,reverseV){var $viewGroupNode,$viewNode=$dataViews.find("view[id="+uiViewsCurrentID+"]"),viewSVGID=$viewNode.attr("svgid");if("svg"===$viewNode.attr("type")){var $txtNode,offsetH,offsetV,offsetLine1,offsetCurrentLine,mx,mxComp,isCompReversed,reverseHCurrentNode,reverseVCurrentNode;$("g[id^="+strEscapeDots(viewSVGID)+"]").each((function(){svgPlanFlipOrientTextHelper($viewGroupNode=$(this),reverseH,reverseV),svgPlanFlipOrientPOIHelper($viewGroupNode,reverseH,reverseV)})),$("g[id^=comps_"+uiViewsCurrentID+"]").find("text").each((function(){try{$txtNode=$(this),mxComp=xfrmSVGGet($txtNode.parents("g[id^=comp_]")),void 0!==reverseH&&(offsetH=this.getBBox().width,offsetLine1=0,$txtNode.find("tspan").each((function(){(offsetCurrentLine=parseFloat($(this).attr("x")))<offsetLine1&&(offsetLine1=offsetCurrentLine)})),offsetH+=2*offsetLine1,isCompReversed=xfrmMatrixIsMirroredX(mxComp),reverseHCurrentNode=reverseH&&!isCompReversed||!reverseH&&isCompReversed),void 0!==reverseV&&(offsetV=this.getBBox().height,$txtNode.find("tspan:first").length,offsetV+=5.5,isCompReversed=xfrmMatrixIsMirroredY(mxComp),reverseVCurrentNode=reverseV&&!isCompReversed||!reverseV&&isCompReversed),mx=xfrmSVGGet($txtNode),mx=xfrmMatrixMirrorAbsolute(mx,reverseHCurrentNode,reverseVCurrentNode,offsetH,offsetV),xfrmSVGSet($txtNode,mx)}catch(ex){dbg("ERROR! "+ex.message)}}))}}function svgPlanFlipOrientTextHelper($svgElement,reverseH,reverseV){var mx,$txtNode,offsetH,offsetV,$tspanNode1,offsetLine1,offsetCurrentLine,fudgeVMultiLine=1.2,fudgeVSingleLine=1.6;isTouchDevice()&&(fudgeVMultiLine=2.4,fudgeVSingleLine=0),$svgElement.find("text").each((function(){try{$txtNode=$(this),void 0!==reverseH&&(offsetH=this.getBBox().width,offsetLine1=0,$txtNode.find("tspan").each((function(){(offsetCurrentLine=parseFloat($(this).attr("x")))<offsetLine1&&(offsetLine1=offsetCurrentLine)})),offsetH+=2*offsetLine1),void 0!==reverseV&&(offsetV=this.getBBox().height,($tspanNode1=$txtNode.find("tspan:first")).length?(offsetLine1=parseFloat($tspanNode1.attr("font-size")),offsetV=(offsetV-(offsetLine1+fudgeVMultiLine))/2*3-offsetV/2):offsetV=(offsetV+fudgeVSingleLine)/2*-1),mx=xfrmSVGGet($txtNode),mx=xfrmMatrixMirrorAbsolute(mx,reverseH,reverseV,offsetH,offsetV),xfrmSVGSet($txtNode,mx)}catch(ex){dbg("ERROR! "+ex.message)}}))}function svgPlanFlipOrientPOIHelper($svgElement,reverseH,reverseV){var $poiNode,mx;$svgElement.find("g[id^=poi\\.]").each((function(){$poiNode=$(this),mx=xfrmSVGGet($poiNode),mx=xfrmMatrixMirrorAbsolute(mx,reverseH,reverseV,OPTION_POI_WIDTH,OPTION_POI_HEIGHT),xfrmSVGSet($poiNode,mx)}))}function svgPlanFlipH(reverse){var $divPlan=$("#divPlan"),mx=xfrmCSSGet($divPlan);mx=xfrmMatrixMirrorAbsolute(mx,reverse,void 0,0,0),xfrmCSSSet($divPlan,mx),svgPlanFlipOrientText(reverse,void 0)}function svgPlanFlipV(reverse){var $divPlan=$("#divPlan"),mx=xfrmCSSGet($divPlan);mx=xfrmMatrixMirrorAbsolute(mx,void 0,reverse,0,0),xfrmCSSSet($divPlan,mx),svgPlanFlipOrientText(void 0,reverse)}function svgPlanXfrm(scale,x,y){var $divPlan=$("#divPlan"),mx=xfrmCSSGet($divPlan);"RESET"===scale?mx=xfrmMatrixScaleAbsolute(mx,1,1):void 0!==scale&&(scale=parseFloat(scale),mx=xfrmMatrixScaleAbsolute(mx,scale,scale));var flipX="true"==$dataInfo.attr("flippedh"),flipY="true"==$dataInfo.attr("flippedv");mx=xfrmMatrixMirrorAbsolute(mx,flipX,flipY,0,0),"RESET"===x?mx=xfrmMatrixMoveAbsolute(mx,0,void 0):void 0!==x&&(x=parseFloat(x),mx=xfrmMatrixMoveAbsolute(mx,x,void 0)),"RESET"===y?mx=xfrmMatrixMoveAbsolute(mx,void 0,0):void 0!==y&&(y=parseFloat(y),mx=xfrmMatrixMoveAbsolute(mx,void 0,y)),xfrmCSSSet($divPlan,mx),svgPlanZoomFinalized=!1}function svgPlanXfrmFinalize(position,scale,scaleCenterPoint,doNotFinalizeScale){var mx,width,height,left,top,cssWidth,cssHeight,cssScale,$divPlan=$("#divPlan"),style="",oldStyle=$divPlan.attr("style"),cssLeft=oldStyle.split("left:"),cssTop=oldStyle.split("top:");if(cssLeft.length>1&&cssTop.length>1)cssLeft=cssLeft[1].split("px",2),cssLeft=parseFloat(cssLeft[0]),cssTop=cssTop[1].split("px",2),cssTop=parseFloat(cssTop[0]);else{var oldPosition=$divPlan.position();cssLeft=parseFloat(oldPosition.left),cssTop=parseFloat(oldPosition.top)}(cssWidth=oldStyle.split("width:")).length>1?(cssWidth=cssWidth[1].split("px",2),cssHeight=(cssWidth=parseFloat(cssWidth[0]))/planPaperAspectRatio):cssHeight=(cssWidth=parseFloat($divPlan.width()))/planPaperAspectRatio,cssScale=cssWidth/svgPlanZoom100Width;var xfrmScaleX=(mx=xfrmCSSGet($divPlan)).e(1,1),xfrmScaleY=mx.e(2,2),xfrmX=mx.e(1,3),xfrmY=mx.e(2,3);if("RESET"===scale&&"RESET"===position)style+="width:"+svgPlanZoom100Width+"px; height:"+svgPlanZoom100Height+"px; left:"+svgPlanZoom100Left+"px; top:"+svgPlanZoom100Top+"px; display: block;",scale=1;else{if("RESET"===scale?(width=svgPlanZoom100Width,height=svgPlanZoom100Height,scale=1):"CALCULATE"===scale?(width=cssWidth*Math.abs(xfrmScaleX),height=cssHeight*Math.abs(xfrmScaleY),scale=Math.abs(cssScale)*Math.abs(xfrmScaleX)):isNaN(scale)?(width=cssWidth,height=cssHeight):(scale=Math.abs(scale),width=svgPlanZoom100Width*scale,height=svgPlanZoom100Height*scale),isNaN(scale)||(100*scale>ZOOM_MAX?(scale=ZOOM_MAX/100,width=svgPlanZoom100Width*scale,height=svgPlanZoom100Height*scale,setTimeout("uiStatusMsg('Zoomed in too far!', false);",0)):100*scale<ZOOM_MIN&&(scale=ZOOM_MIN/100,width=svgPlanZoom100Width*scale,height=svgPlanZoom100Height*scale,setTimeout("uiStatusMsg('Zoomed out too far!', false);",0))),style+="width:"+width+"px; height:"+height+"px; ","RESET"===position)left=svgPlanZoom100Left+svgPlanZoom100Width/2-width/2,top=svgPlanZoom100Top+svgPlanZoom100Height/2-height/2;else if("CALCULATE"===position)if(isNaN(scale))left=cssLeft+xfrmX,top=cssTop+xfrmY;else if(void 0===scaleCenterPoint){left=cssLeft-(width-cssWidth)/2+xfrmX,top=cssTop-(height-cssHeight)/2+xfrmY}else{"CALCULATE"===scaleCenterPoint&&($divStage=$("#divStage"),scaleCenterPoint={x:$divStage.width()/2,y:$divStage.height()/2});var coordsPlan=svgPlanGetCoordsForPlan(scaleCenterPoint.x,scaleCenterPoint.y),scaleDiff=Math.abs(scale/cssScale);coordsPlan.x*=scaleDiff,coordsPlan.y*=scaleDiff;var coordsPageScaled=svgPlanGetCoordsForPage(coordsPlan.x,coordsPlan.y),pageDiffX=coordsPageScaled.x-scaleCenterPoint.x,pageDiffY=coordsPageScaled.y-scaleCenterPoint.y;left="true"==$dataInfo.attr("flippedh")?cssLeft+pageDiffX+xfrmX:cssLeft-pageDiffX+xfrmX,top="true"==$dataInfo.attr("flippedv")?cssTop+pageDiffY+xfrmY:cssTop-pageDiffY+xfrmY}else isNaN(position.left)||isNaN(position.top)?(left=cssLeft,top=cssTop):dbg("WARNING! missing code for this case!");style+="left:"+left+"px; top:"+top+"px; "}if($divPlan.attr("style",style+" display:block;"),void 0!==scale){var flipX="true"==$dataInfo.attr("flippedh"),flipY="true"==$dataInfo.attr("flippedv");mx=xfrmMatrixGetDefault(),mx=xfrmMatrixMirrorAbsolute(mx,flipX,flipY,0,0),xfrmCSSSet($divPlan,mx)}else 0===xfrmScaleX&&0===xfrmScaleY||(mx=xfrmMatrixGetDefault(),mx=xfrmMatrixScaleAbsolute(mx,xfrmScaleX,xfrmScaleY),xfrmCSSSet($divPlan,mx));void 0!==position||0===xfrmX&&0===xfrmY||(mx=xfrmMatrixGetDefault(),mx=xfrmMatrixMoveAbsolute(mx,xfrmX,xfrmY),xfrmCSSSet($divPlan,mx)),!0!==doNotFinalizeScale&&(svgPlanZoomFinalized=!0,svgPlanZoomFinalizedScale=isNaN(scale)?cssScale:scale)}function svgPlanZoom(percent,finalize){if("INIT"===percent){var $divStage=$("#divStage"),availWidth=$divStage.width(),availHeight=$divStage.height();availHeight-=parseInt(strStripNonNumeric($divStage.css("padding-top")),10);var $divSidebar=$("#pnlMainC"),centerOffset=0;isSmallScreen()||(centerOffset=parseInt(strStripNonNumeric($divSidebar.css("width")),10)),$("#pnlMain").hasClass("swap-left-right")?(isSmallScreen()||(availWidth-=46),$divSidebar.hasClass("ui-drawer-open")&&(availWidth+=centerOffset)):(isSmallScreen()||(availWidth+=46),$divSidebar.hasClass("ui-drawer-open")&&(availWidth-=centerOffset)),availWidth/availHeight<planAspectRatio?(svgPlanZoom100Width=planPaperWidth*(availWidth/planWidth),svgPlanZoom100Height=svgPlanZoom100Width/planPaperAspectRatio):(svgPlanZoom100Height=planPaperHeight*(availHeight/planHeight),svgPlanZoom100Width=svgPlanZoom100Height*planPaperAspectRatio),svgPlanZoom100Left=(availWidth-svgPlanZoom100Width)/2,svgPlanZoom100Top=(availHeight-svgPlanZoom100Height)/2,svgPlanZoom100AbsoluteScale=planPaperWidth/svgPlanZoom100Width,svgPlanXfrmFinalize("RESET","RESET",void 0)}else if("ALL"===percent)svgPlanZoom("INIT",finalize);else{svgPlanXfrmFinalize("CALCULATE",parseFloat(percent)/100,"CALCULATE")}svgPlanZoomFinalized=finalize,planZoomCompleted(percent,finalize)}function svgPlanTouchZoomEnable(){$divPlan=$("#divPlan"),$divPlan.hammer(),$divPlan.data("hammer").add(new Hammer.Pinch),$divPlan.on("pinchstart pinch pinchend",svgPlanTouchZoom)}function svgPlanTouchZoomDisable(){$("#divPlan").off("pinchstart pinch pinchend",svgPlanTouchZoom)}function svgPlanTouchZoom(e){if(dbg("svgPlanTouchZoom(e.type) "+e.type),e.gesture){var scale=e.gesture.scale*svgPlanZoomFinalizedScale,scaleCenter={x:e.gesture.center.x,y:e.gesture.center.y};"pinchstart"===e.type?(svgPlanPanDisable(),svgPlanXfrmFinalize("CALCULATE",scale,scaleCenter,!0)):"pinch"===e.type?(e.gesture.scale<.3&&(scale=.3*svgPlanZoomFinalizedScale),svgPlanXfrmFinalize("CALCULATE",scale,scaleCenter,!0)):"pinchend"===e.type&&(svgPlanXfrmFinalize("CALCULATE","CALCULATE",scaleCenter),setTimeout(svgPlanPanEnable,100),planZoomCompleted(100*svgPlanZoomFinalizedScale,!0))}}function svgPlanPanEnable(){$divPlan=$("#divPlan"),$divPlan.hammer(),$divPlan.data("hammer").get("pan").set({direction:Hammer.DIRECTION_ALL}),$divPlan.on("panstart pan panend",svgPlanPan)}function svgPlanPanDisable(){$("#divPlan").off("panstart pan panend",svgPlanPan)}function svgPlanPan(e){if(dbg("svgPlanPan(e.type) "+e.type),e.gesture){$("#divPlan");"panstart"===e.type||"pan"===e.type?svgPlanXfrm(void 0,e.gesture.deltaX,e.gesture.deltaY):"panend"===e.type&&svgPlanXfrmFinalize("CALCULATE",void 0,void 0)}}