var dataPlanID,dataSavedPlanID,dataSavedPlanURL,dataSavedPlanName,dataSavedPlanShareImgURL,dataSoftSaveTimer,$dataInfo,$dataSitePlanInfo,$dataComponents,$dataOptions,$dataOptionsLogic,$dataViews,$dataCurrentUser,dataCompScale,dataCompScaleFurniture,dataTmpSavedPlanResponseMessage,dataTmpSavedPlanInfo,dataTmpSavedPlanOptions,dataTmpSavedPlanDrops,dataSoftSaveInterval=15e3,dataIsLoaded=!1,dataCompMetric=!1,dataDropCounter=0,dataNoticeMsgCssVars={SkinColorBackground:"",SkinColorText:"",SkinColorFill:"",SkinColorAccent:""},dataURLGetRecord="/plan.get.php?rid=",dataURLGetSavedRecord="/plan.getsaved.php?rid=",dataURLStoreSavedRecord="/plan.save.php";function dataPlanLoad(planID){dataIsLoaded=!1;var $divPlan=$("#divPlan");if($divPlan.html(""),uiStatusMsgStartup(),void 0!==planID&&"string"==typeof planID&&(dataPlanID=planID),dataPlanID){$divPlan.hide();var url=dataURLGetRecord+dataPlanID;dataSavedPlanID&&(url+="&sid="+dataSavedPlanID),url+=dataPlanURLGetLotIdQueryString(),$.ajax({url:url,dataType:"xml",success:dataPlanParse,error:dataPlanLoadError})}else uiStatusMsgErr("Error! No record.")}function dataPlanLoadSaved(planID,savedPlanID){if(dataIsLoaded=!1,uiStatusMsgStartup(),void 0!==planID&&"string"==typeof planID&&(dataPlanID=planID),void 0!==savedPlanID&&"string"==typeof savedPlanID&&(dataSavedPlanID=savedPlanID),dataSavedPlanID){$("#divPlan").hide();var url=dataURLGetSavedRecord+dataSavedPlanID;url+="&"+dataPlanURLGetLotIdQueryString(),$.ajax({url:url,dataType:"text",success:dataPlanParseSaved,error:dataPlanLoadError})}else uiStatusMsgErr("Error! No saved record.")}function dataPlanURLGetLotIdQueryString(){var qs="",urlQS=$.deparam.querystring();return urlQS.lotid&&(qs="&lotid="+urlQS.lotid),qs}function dataPlanLoadError(jqXHR,textStatus,errorThrown){uiStatusMsgErr("Error! Could not load the record: "+jqXHR.responseText)}function dataPlanParse(data,textStatus,jqXHR){if(dbg("dataPlanParse"),"string"==typeof data&&data.indexOf("Error!")>=0)uiStatusMsgErr(data);else{var $xml=$(data),$userNode=$xml.find("currentuser");$dataCurrentUser=void 0,$userNode.text()&&($dataCurrentUser=JSON.parse($userNode.text())),$dataInfo=$xml.find("planinfo"),$dataSitePlanInfo=$xml.find("siteplaninfo"),($dataViews=$xml.find("views")).find("view").each((function(){$("<drops/>").appendTo($(this))})),dataDropCounter=0,$dataOptions=$xml.find("options"),dataPlanParse_InitOptionsDefaults(),$dataOptions.find("option[data1*=\\.poi]").each((function(){$(this).attr("selected",1)})),$dataPromoTags=$xml.find("promotags");var qstext=location.search.substring(1);if(qstext.length>0)for(var qsobj=JSON.parse('{"'+qstext.replace(/&/g,'","').replace(/=/g,'":"')+'"}',(function(key,value){return""===key?value:decodeURIComponent(value)})),props=Object.keys(qsobj),i=0;i<props.length;i++){var tag=props[i];$dataPromoTags.find('tag[promotag*="'+tag+'"]').each((function(){if($(this).attr("minvalue")==qsobj[props[i]]||$(this).attr("minvalue")<=qsobj[props[i]]&&$(this).attr("maxvalue")>=qsobj[props[i]]){var tagid=$(this).attr("id");$dataOptions.find("[promotagids]").each((function(){for(var ids=$(this).attr("promotagids").split(","),i2=0;i2<ids.length;i2++)ids[i2]==tagid&&($(this).attr("selected",1),$(this).attr("promoted",1))}))}}))}$dataPromoTags.find("tag").each((function(){if(thistag=$(this).attr("promotag"),"undefined"==typeof thistag||""==thistag){var tagid=$(this).attr("id");$dataOptions.find("[promotagids]").each((function(){for(var ids=$(this).attr("promotagids").split(","),i2=0;i2<ids.length;i2++)ids[i2]==tagid&&($(this).attr("selected",1),$(this).attr("promoted",1))}))}})),$dataOptionsLogic=$xml.find("optionslogic"),$dataComponents=$xml.find("components");var compScale=$dataInfo.attr("componentscale");compScale&&!isNaN(compScale)&&(dataCompScale=compScale);var compScaleFurniture=$dataInfo.attr("componentfurniturescale");compScaleFurniture&&!isNaN(compScaleFurniture)&&(dataCompScaleFurniture=compScaleFurniture),$dataCustomFields=$xml.find("customfields"),"1"==$dataInfo.attr("clientismetric")?(dataCompMetric=!0,$dataInfo.attr("clientismetric",!0),$dataInfo.attr("clientareatext"," M2")):(dataCompMetric=!1,$dataInfo.attr("clientismetric",!1),$dataInfo.attr("clientareatext"," sq ft")),dataSavedPlanID&&(dataMergeSavedPlanInfo(),dataMergeSavedOptions(),dataMergeSavedDrops()),dataCheckQuerystringDemographics(),now=new Date,dataSoftSaveTimer=now.getTime()-dataSoftSaveInterval,uiSetupAfterData(),svgPlanLoad()}}function dataPlanParse_InitOptionsDefaults(){optionsSetupInitiallySelected=[],$dataOptions.find("option").each((function(){$optXMLNode=$(this),optID=$optXMLNode.attr("id"),"1"===$optXMLNode.attr("selected")&&optionsSetupInitiallySelected.push(optID),$optXMLNode.attr("selected","0"),$optXMLNode.attr("enabled","1"),$optXMLNode.attr("visible","1")}))}function dataPlanParseSaved(data,textStatus,jqXHR){"string"==typeof data&&data.indexOf("Error!")>=0?uiStatusMsgErr(data):(data=(data=JSON.parse(data))[0],(dataTmpSavedPlanInfo={}).SavedPlanFirstName=data.SavedPlanFirstName,dataTmpSavedPlanInfo.SavedPlanLastName=data.SavedPlanLastName,dataTmpSavedPlanInfo.SavedPlanEmail=data.SavedPlanEmail,dataTmpSavedPlanInfo.SavedPlanPhone=data.SavedPlanPhone,dataTmpSavedPlanInfo.SavedPlanName=data.SavedPlanName,dataTmpSavedPlanInfo.SavedPlanFlippedH=1==data.SavedPlanFlippedH,dataTmpSavedPlanInfo.SavedPlanFlippedV=1==data.SavedPlanFlippedV,dataTmpSavedPlanOptions=(dataTmpSavedPlanOptions=data.SavedPlanOptions)&&dataTmpSavedPlanOptions.length>0?JSON.parse(dataTmpSavedPlanOptions):void 0,dataTmpSavedPlanDrops=(dataTmpSavedPlanDrops=data.SavedPlanComponents)&&dataTmpSavedPlanDrops.length>0?JSON.parse(dataTmpSavedPlanDrops):void 0,dataPlanLoad(data.PlanID))}function dataMergeSavedPlanInfo(){dataTmpSavedPlanInfo&&($dataInfo.attr("savedplanfirstname",dataTmpSavedPlanInfo.SavedPlanFirstName),$dataInfo.attr("savedplanlastname",dataTmpSavedPlanInfo.SavedPlanLastName),$dataInfo.attr("savedplanemail",dataTmpSavedPlanInfo.SavedPlanEmail),$dataInfo.attr("savedplanphone",dataTmpSavedPlanInfo.SavedPlanPhone),$dataInfo.attr("savedplanname",dataTmpSavedPlanInfo.SavedPlanName),$dataInfo.attr("flippedh",dataTmpSavedPlanInfo.SavedPlanFlippedH),$dataInfo.attr("flippedv",dataTmpSavedPlanInfo.SavedPlanFlippedV)),dataTmpSavedPlanInfo=void 0}function dataMergeSavedOptions(){if(dataTmpSavedPlanOptions)for(var optData,$optNode,i=0;i<dataTmpSavedPlanOptions.length;i++){optData=dataTmpSavedPlanOptions[i];var $optGroupNode=($optNode=$dataOptions.find("option[id=o-"+optData.optionid+"]")).parent();"ext"===$optGroupNode.attr("typecode")&&$optGroupNode.children("option").attr("selected","0"),$optNode.attr("visible","1"),$optNode.attr("enabled","1"),$optNode.attr("selected","1")}dataTmpSavedPlanOptions=void 0}function dataMergeSavedDrops(){if(dataTmpSavedPlanDrops){var dropData,dropID,$dropNode,$viewsDropsNode;dataDropCounter=0;for(var i=0;i<dataTmpSavedPlanDrops.length;i++)dropData=dataTmpSavedPlanDrops[i],dropID=dataDropCounter++,($dropNode=$("<drop />")).attr("componentid","c-"+dropData.componentid),$dropNode.attr("dropid",dropID),$dropNode.attr("type",dropData.type),$dropNode.attr("rotation",dropData.rotation),$dropNode.attr("flippedh",dropData.flippedh),$dropNode.attr("flippedv",dropData.flippedv),$dropNode.attr("forcetop",dropData.forcetop),$dropNode.attr("forcebottom",dropData.forcebottom),$dropNode.attr("x",dropData.x),$dropNode.attr("y",dropData.y),$dropNode.attr("position",dropData.position),$dropNode.attr("data",dropData.data),$dropNode.attr("dimensionwidth",dropData.dimensionwidth),$dropNode.attr("dimensionheight",dropData.dimensionheight),$dropNode.attr("dimensionfixed",dropData.dimensionfixed),$dropNode.attr("dimensionnosize",dropData.dimensionnosize),$dropNode.attr("scalex",dropData.scalex),$dropNode.attr("scaley",dropData.scaley),$viewsDropsNode=$dataViews.find("view[id=v-"+dropData.viewid+"] drops"),$dropNode.appendTo($viewsDropsNode)}dataTmpSavedPlanDrops=void 0}function dataCheckQuerystringDemographics(){var qstext=location.search.substring(1);if(qstext.length>0)for(var qsobj=JSON.parse('{"'+qstext.replace(/&/g,'","').replace(/=/g,'":"')+'"}',(function(key,value){return""===key?value:decodeURIComponent(value)})),props=Object.keys(qsobj),prop_map={UserFirstName:"txtFirstName",UserLastName:"txtLastName",UserEmail:"txtEmail",UserPhone:"txtPhone"},info_map={UserFirstName:"savedplanfirstname",UserLastName:"savedplanlastname",UserEmail:"savedplanemail",UserPhone:"savedplanphone"},i=0;i<props.length;i++)for(var key=props[i],fields=Object.keys(prop_map),i2=0;i2<fields.length;i2++)if(fields[i2]==key){fieldname=fields[i2],$("#"+prop_map[fieldname]).val(qsobj[key]),$dataInfo.attr(info_map[fieldname],qsobj[key]);break}}function dataPlanSave(prefixID,successFunc,softsave){dbg("dataPlanSave(prefixID, successFunc, softsave) "+prefixID+","+successFunc+","+softsave),0==(softsave=softsave||0)&&(successFunc=successFunc||dataPlanSaveCreateShareImg.name,uiStatusMsg("Saving...",!0));var savedPlanFirstName=$("#"+prefixID+"FirstName").val(),savedPlanLastName=$("#"+prefixID+"LastName").val(),savedPlanEmail=$("#"+prefixID+"Email").val();dataSavedPlanName=$("#"+prefixID+"SavedPlanName").val();var savedPlanPhone=$("#"+prefixID+"Phone").val(),savedPlanSendSms=$("#"+prefixID+"SendSms").attr("checked")?1:0,savedPlanPhoneRequired="1"==$dataInfo.attr("clientsaveplanphonerequired")?1:0,CustomInputXML="<CustomInputs>\n";$("[id^="+prefixID+"CustomInput]").each((function(index){CustomInputXML+="\t<"+$(this).attr("name"),CustomInputXML+=">"+encodeURIComponent($(this).val())+"</"+$(this).attr("name")+">"})),CustomInputXML+="</CustomInputs>";var planFlippedH="true"==$dataInfo.attr("flippedh")?1:0,planFlippedV="true"==$dataInfo.attr("flippedv")?1:0,optData=dataPlanSaveGetOptions(),dropData=dataPlanSaveGetDrops(),planSelectedOptionsList=dataPlanSaveGetSelectedOptionsList(),savedPlanPreviewImgUrl=dataPlanSaveGetPreviewImgUrl(),savedPlanElevationImgUrl=dataPlanSaveGetElevationImgUrl(),savedPlanComponentGroupIDs=dataPlanSaveGetComponentGroupIDs(),noticeMsgCssVarsJson=JSON.stringify(dataNoticeMsgCssVars),lotId="",urlQS=$.deparam.querystring();urlQS.lotid&&(lotId=urlQS.lotid),$.ajax({url:dataURLStoreSavedRecord,type:"POST",data:{planURLBasePath:dataURLBasePath,planID:dataPlanID,planFlippedH:planFlippedH,planFlippedV:planFlippedV,planOptions:optData,planDrops:dropData,savedPlanID:dataSavedPlanID,savedPlanFirstName:savedPlanFirstName,savedPlanLastName:savedPlanLastName,savedPlanEmail:savedPlanEmail,savedPlanPhone:savedPlanPhone,savedPlanName:dataSavedPlanName,savedPlanSendSms:savedPlanSendSms,savedPlanPhoneRequired:savedPlanPhoneRequired,planSelectedOptionsList:planSelectedOptionsList,savedPlanPreviewImgUrl:savedPlanPreviewImgUrl,savedPlanElevationImgUrl:savedPlanElevationImgUrl,savedPlanIfpVersion:dataIfpVersion,savedPlanSkinPath:dataSkinPath,savedPlanComponentGroupIDs:savedPlanComponentGroupIDs,noticeMsgCssVarsJson:noticeMsgCssVarsJson,CustomInputs:CustomInputXML,softsave:softsave,protocol:savesupplement.SERVER_PROTOCOL,http_host:savesupplement.SERVER_HTTP_HOST,http_user_agent:savesupplement.SERVER_HTTP_USER_AGENT,http_cookie:savesupplement.SERVER_HTTP_COOKIE,remote_addr:savesupplement.SERVER_REMOTE_ADDR,query_string:savesupplement.SERVER_QUERY_STRING,request_uri:savesupplement.SERVER_REQUEST_URI,request_time:savesupplement.SERVER_REQUEST_TIME,last_activity:savesupplement.SESSION_LAST_ACTIVITY,user_userid:savesupplement.SESSION_USER_USER_ID,user_usertypeid:savesupplement.SESSION_USER_USERTYPEID,vipuserguid:savesupplement.COOKIE_VIPUSERGUID,successFunc:successFunc,lotId:lotId},success:dataPlanSaveSuccess,error:dataPlanSaveError})}function dataPlanSaveSuccess(data,textStatus,jqXHR){dbg("dataPlanSaveSuccess(data, textStatus, jqXHR)"+data+","+textStatus+","+jqXHR);var msgResponse="Error!";if("string"==typeof data&&data.indexOf("Error!")>=0)uiStatusMsgErr(data);else{try{msgResponse=(data=JSON.parse(data)).Message,dataSavedPlanID=data.SavedPlanGUID,dataSavedPlanURL=data.SavedPlanURL,dataSavedPlanShareImgURL=data.SavedPlanShareImgURL;var successFunc=data.successFunc;successFunc&&"false"!==successFunc&&window[successFunc](dataSavedPlanID,dataSavedPlanURL)}catch(ex){msgResponse="Error!",dataSavedPlanID=void 0}data.hasOwnProperty("softsave")||(dataSavedPlanID?socialShareEnabled?dataSavePlanShowShareDialog(msgResponse):uiStatusMsg(msgResponse):uiStatusMsgErr("Error! The plan may not have been saved."))}dbg("dataSavedPlanID = "+dataSavedPlanID)}function dataPlanSaveError(jqXHR,textStatus,errorThrown){uiStatusMsgErr("Error! Could not save the plan: "+jqXHR.responseText)}function dataPlanSaveGetComponentGroupIDs(){var compIDs=[];return $dataComponents.find("group").each((function(){compIDs.push(strStripNonNumeric($(this).attr("id")))})),compIDs=compIDs.join(",")}function dataPlanSaveGetSelectedOptionsList(){var optSelected=[];return $dataOptions.find('options > group[typecode="opt"] > option[selected="1"]').each((function(){optSelected.push($(this).attr("displayname"))})),optSelected=optSelected.join(", ")}function dataPlanSaveGetPreviewImgUrl(){var url=$dataOptions.find('options > group[typecode="ext"] > option[selected="1"]').attr("data1");return url||(url=$dataInfo.attr("previewfile")),url||(url=$("#imgPreview").attr("src")),url}function dataPlanSaveGetElevationImgUrl(){return $dataOptions.find('options > group[typecode="ext"] > option[selected="1"]').attr("data2")}function dataPlanSaveCreateShareImg(saved_plan_guid,plan_url){dbg("dataPlanSaveCreateShareImg(saved_plan_guid, plan_url) "+saved_plan_guid+","+plan_url);var $pagesContainer=$("#layoutPrintFrame").contents().find("html body");$pagesContainer.empty(),svgPrint($pagesContainer,!1,!0,void 0,saved_plan_guid)}function dataPlanSaveGetOptions(){var opt,$optNode,opts=[];return $dataOptions.find("option[selected=1]").each((function(){$optNode=$(this),(opt={optionid:0}).optionid=$optNode.attr("id"),opt.optionid=strStripNonNumeric(opt.optionid),opts.push(opt)})),opts&&opts.length>0?JSON.stringify(opts):""}function dataPlanSaveGetDrops(){var drop,$dropNode,drops=[];return $dataViews.find("drop").each((function(){$dropNode=$(this),(drop={viewid:0,componentid:0,dropid:0,type:"",rotation:0,flippedh:!1,flippedv:!1,forcetop:!1,forcebottom:!1,x:0,y:0,position:{},data:{}}).viewid=$dropNode.parents("view").attr("id"),drop.viewid=strStripNonNumeric(drop.viewid),drop.componentid=$dropNode.attr("componentid"),drop.componentid=strStripNonNumeric(drop.componentid),drop.dropid=$dropNode.attr("dropid"),drop.type=$dropNode.attr("type"),drop.rotation=$dropNode.attr("rotation"),drop.flippedh=$dropNode.attr("flippedh"),drop.flippedv=$dropNode.attr("flippedv"),drop.forcetop=$dropNode.attr("forcetop"),drop.forcebottom=$dropNode.attr("forcebottom"),drop.x=$dropNode.attr("x"),drop.y=$dropNode.attr("y"),drop.position=$dropNode.attr("position"),drop.data=$dropNode.attr("data"),drop.dimensionwidth=$dropNode.attr("dimensionwidth"),drop.dimensionheight=$dropNode.attr("dimensionheight"),drop.dimensionfixed=$dropNode.attr("dimensionfixed"),drop.dimensionnosize=$dropNode.attr("dimensionnosize"),drop.scalex=$dropNode.attr("scalex"),drop.scaley=$dropNode.attr("scaley"),drops.push(drop)})),drops&&drops.length>0?JSON.stringify(drops):""}function dataSavePlanShowShareDialog(htmlMessage){var dataSavedPlanTitle=dataSavedPlanName+" (Floorplan)",dataSavedPlanDescription="My customized "+$dataInfo.attr("displayname")+" Interactive Floorplan";window.__sharethis__.load("inline-share-buttons",{alignment:"center",enabled:!0,font_size:12,padding:8,radius:2,size:32,spacing:8,show_mobile_buttons:!1,show_total:!1,labels:"cta",networks:["facebook","twitter","pinterest"],id:"divShareThis",url:dataSavedPlanURL,title:dataSavedPlanTitle,image:dataSavedPlanShareImgURL,description:dataSavedPlanDescription}),$("#pDialogShareSaveMsg").html(htmlMessage),setTimeout("$('#layoutDialogShare').popup('open');",250),setTimeout("uiStatusMsgClear();",250)}