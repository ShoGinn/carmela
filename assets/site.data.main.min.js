"use strict";
(window.Site = window.Site || {}),
    (window.Site.Data = window.Site.Data || {}),
    (window.Site.Data.Main = (function ($, undefined) {
        var self = {};
        (self.$dataLegends = undefined),
            (self.$dataAvailablePlans = undefined),
            (self.$dataAvailableExteriors = undefined),
            (self.recordParse = function (data, textStatus, jqXHR) {
                if ("string" == typeof data && data.indexOf("Error!") >= 0)
                    uiStatusMsgErr(data);
                else {
                    var $xml = $(data),
                        $userNode = $xml.find("currentuser");
                    (window.$dataCurrentUser = undefined),
                        $userNode.text() &&
                        (window.$dataCurrentUser = JSON.parse($userNode.text())),
                        (window.$dataInfo = $xml.find("siteinfo")),
                        (window.$dataViews = $xml.find("views")),
                        (window.$dataOptions = $xml.find("options")),
                        (window.$dataCustomFields = $xml.find("customfields")),
                        (window.$dataOptionsLogic = $xml.find("optionslogic")),
                        (self.$dataLegends = $xml.find("legends")),
                        (self.$dataAvailablePlans = $xml.find("availableplans")),
                        (self.$dataAvailableExteriors = $xml.find("availableexteriors")),
                        uiSetupAfterData(),
                        svgPlanLoad();
                }
            }),
            (self.oFnOv_recordParse = undefined),
            (self.recordSave = function (prefixID, strFnNameCallbackAfterSuccess) {
                strFnNameCallbackAfterSuccess || (strFnNameCallbackAfterSuccess = ""),
                    $.ajax({
                        url: window.dataURLStoreSavedRecord,
                        type: "POST",
                        data: {
                            recordID: VIP.Main.recordID,
                            siteOptions: xmlToString(window.$dataOptions),
                            fnNameCallbackAfterSuccess: strFnNameCallbackAfterSuccess,
                        },
                        success: self.recordSaveOnSuccess,
                        error: self.recordSaveOnError,
                    });
            }),
            (self.oFnOv_recordSave = undefined),
            (self.recordSaveSingleOption = function (optionID) {
                var optionXML = xmlToString(
                    window.$dataOptions.find("option[id=" + strEscapeDots(optionID) + "]")
                );
                (optionXML = "<options><group>" + optionXML + "</group></options>"),
                    $.ajax({
                        url: window.dataURLStoreSavedRecord,
                        type: "POST",
                        data: { recordID: VIP.Main.recordID, siteOptions: optionXML },
                        success: self.recordSaveOnSuccess,
                        error: self.recordSaveOnError,
                    });
            }),
            (self.recordSaveOnSuccess = function (data, textStatus, jqXHR) {
                var msgResponse = undefined;
                if ("string" == typeof data && data.indexOf("Error!") >= 0)
                    uiStatusMsgErr(data);
                else {
                    try {
                        msgResponse = (data = JSON.parse(data)).Message;
                        var fnCallback = data.fnNameCallbackAfterSuccess;
                        fnCallback &&
                            "undefined" !== fnCallback &&
                            window[fnCallback].apply(self.recordSaveOnSuccess, arguments);
                    } catch (ex) {
                        msgResponse = undefined;
                    }
                    msgResponse
                        ? uiStatusMsg(msgResponse)
                        : uiStatusMsgErr("Error! The site may not have been saved.");
                }
            }),
            (self.recordSaveOnError = function (jqXHR, textStatus, errorThrown) {
                uiStatusMsgErr("Error! Could not save the site: " + jqXHR.responseText);
            });
        return (
            (self.oFnOv_recordParse = VIP.Util.FnOverride(
                "dataPlanParse",
                self.recordParse
            )),
            (self.oFnOv_recordSave = VIP.Util.FnOverride(
                "dataPlanSave",
                self.recordSave
            )),
            (window.dataURLGetRecord = "/assets/"),
            (window.dataURLStoreSavedRecord = "/site.save.php"),
            self
        );
    })(jQuery));
